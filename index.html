<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>贈与税試算ツール（暦年課税・相続時精算課税・長期シミュレーション）</title>

  <link rel="icon" type="image/png" sizes="192x192" href="./favicon192192.png" />
  <link rel="apple-touch-icon" href="./favicon192192.png" />
  <meta name="theme-color" content="#578899" />

  <style>
    :root{
      --bg:#f4f9fb;
      --card:#ffffff;
      --ink:#1e2a2d;
      --muted:#5a6a6d;
      --accent:#578899;
      --accent-dark:#476a7c;
      --accent-soft:rgba(87,136,153,.08);
      --border:#d4e1e7;
      --danger:#b42318;
      --shadow:0 18px 40px rgba(20,50,70,.12);
      --radius-lg:18px;
      --radius-pill:999px;
      
      /* ボタン用カラー定義 */
      --btn-soft-bg: #f0f8fa;
      --btn-soft-border: #dbe9ee;
      --btn-soft-text: #4a7d8f;
      --btn-outline-border: #4a7d8f;
    }
    *{box-sizing:border-box;}
    html,body{height:100%;}
    body{
      margin:0;
      font-size: 15px;
      font-family:-apple-system,BlinkMacSystemFont,"Hiragino Kaku Gothic ProN","Yu Gothic","Noto Sans JP",Segoe UI,Roboto,Arial,sans-serif;
      background:var(--bg);
      color:var(--ink);
      -webkit-text-size-adjust: 100%;
      line-height: 1.6;
    }
    .app{
      min-height:100vh;
      display:flex;
      flex-direction:column;
    }
    .app-header{
      background:var(--bg);
      padding:12px 16px 8px;
      border-bottom:1px solid #d4e1e7;
      position: sticky;
      top: 0;
      z-index: 100;
      backdrop-filter: blur(8px);
      background: rgba(244, 249, 251, 0.95);
    }
    .header-bar{
      max-width:1080px;
      margin:0 auto;
      display:flex;
      align-items:center;
      gap:12px;
      justify-content: space-between;
    }
    .brand{
      display:inline-flex;
      align-items:center;
      gap:12px;
      text-decoration:none;
      color:var(--ink);
      flex:1 1 auto;
      min-width: 0;
    }
    .brand-logo{
      height:44px;
      width:auto;
      display:block;
      border-radius:12px;
      object-fit:contain;
      background:transparent;
      padding:0;
      flex-shrink: 0;
    }
    .brand-text{
      display:flex;
      flex-direction:column;
      gap:2px;
      min-width: 0;
    }
    .brand-title{
      font-size:22px;
      margin:0;
      font-weight:700;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }
    .brand-subtitle{
      margin:0;
      font-size:12px;
      color:var(--muted);
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }
    .layout{
      width:100%;
      max-width:1080px;
      margin:0 auto;
      padding:16px;
      flex:1 0 auto;
    }
    .card{
      background:var(--card);
      border-radius:var(--radius-lg);
      box-shadow:var(--shadow);
      padding:24px;
      margin-bottom:20px;
      border:1px solid rgba(255,255,255,.8);
    }
    .card-header{
      display:flex;
      justify-content:space-between;
      align-items:flex-start;
      gap:8px;
      margin-bottom:16px;
      flex-wrap: wrap;
    }
    .card-title{
      margin:0;
      font-size:18px;
      font-weight:700;
      display:flex;
      align-items:center;
      gap:10px;
    }
    .badge{
      display:inline-flex;
      align-items:center;
      padding:4px 10px;
      border-radius:var(--radius-pill);
      border:1px solid rgba(255,255,255,.8);
      font-size:11px;
      background:rgba(0,0,0,.2);
      white-space: nowrap;
    }
    .pill-switch{
      display:inline-flex;
      padding:4px;
      border-radius:var(--radius-pill);
      background:#edf3f6;
      border:1px solid #d3e1ea;
      gap:4px;
    }
    .pill-switch label{
      position:relative;
      display:inline-flex;
      align-items:center;
      justify-content:center;
      padding:8px 16px;
      border-radius:var(--radius-pill);
      font-size:14px;
      cursor:pointer;
      white-space:nowrap;
      color:var(--muted);
      transition:background .18s ease,color .18s ease;
    }
    .pill-switch input{display:none;}
    .pill-switch input:checked + span{
      background:#fff;
      color:var(--accent);
      box-shadow:0 0 0 1px rgba(87,136,153,.4);
    }
    .pill-switch span{
      border-radius:var(--radius-pill);
      padding:8px 16px;
    }
    .card-body{
      font-size:15px;
      color:var(--muted);
    }
    .grid{
      display:grid;
      gap:16px 20px;
    }
    @media(min-width:800px){
      .grid-2{
        grid-template-columns:repeat(2,minmax(0,1fr));
      }
      .grid-3{
        grid-template-columns:repeat(3,minmax(0,1fr));
      }
    }
    .field{
      display:flex;
      flex-direction:column;
      gap:6px;
    }
    .field label{
      font-size:14px;
      font-weight:700;
      color:var(--ink);
    }
    .field small{
      font-size:12px;
      color:var(--muted);
      line-height: 1.5;
    }
    /* 入力欄 */
    input[type="number"],
    input[type="text"],
    select{
      border-radius:10px;
      border:1px solid var(--border);
      padding:12px;
      font-size:16px;
      font-family:inherit;
      outline:none;
      width:100%;
      background:#f9fcff;
      transition:border-color .16s ease,box-shadow .16s ease,background .16s ease;
      text-align: right;
    }
    input[type="number"]:focus,
    input[type="text"]:focus,
    select:focus{
      border-color:var(--accent);
      box-shadow:0 0 0 1px rgba(87,136,153,.3);
      background:#fff;
    }
    input[type="number"].align-left{
      text-align:left;
    }
    .radio-row{
      display:flex;
      flex-wrap:wrap;
      gap:10px;
      margin-top:6px;
    }
    .radio-chip{
      display:inline-flex;
      align-items:center;
      gap:6px;
      padding:8px 12px;
      border-radius:var(--radius-pill);
      border:1px solid var(--border);
      background:#f7fafb;
      font-size:13px;
      color:var(--muted);
      cursor:pointer;
      transition: all 0.2s ease;
    }
    .radio-chip:active { transform: scale(0.98); }
    .radio-chip input{display:none;}
    .radio-chip input:checked + span{
      color:var(--accent);
      font-weight:600;
    }
    .radio-chip span::before{
      content:"";
      display:inline-block;
      width:12px;
      height:12px;
      border-radius:999px;
      border:1px solid var(--border);
      margin-right:4px;
      background:#fff;
    }
    .radio-chip input:checked + span::before{
      border-color:var(--accent);
      box-shadow:0 0 0 3px rgba(87,136,153,.25);
      background:radial-gradient(circle at center, var(--accent) 0 55%, #fff 55% 100%);
    }

    .btn-row{
      display:flex;
      flex-wrap:wrap;
      gap:12px;
      margin-top:20px;
      align-items:center;
    }
    /* 計算ボタン用 */
    .btn-calc{
      border:none;
      border-radius:var(--radius-pill);
      padding:12px 28px;
      font-size:15px;
      font-weight:700;
      background:var(--accent);
      color:#fff;
      cursor:pointer;
      display:inline-flex;
      align-items:center;
      justify-content: center;
      gap:8px;
      box-shadow:0 10px 24px rgba(87,136,153,.45);
      transition:transform .1s ease,box-shadow .1s ease,background .1s ease;
    }
    .btn-calc:hover{
      background:#4d7a8e;
      transform:translateY(-1px);
      box-shadow:0 12px 28px rgba(87,136,153,.55);
    }
    .btn-calc:active{
      transform:translateY(1px);
    }
    .btn-calc-icon{
      font-size:16px;
    }
    /* 入力クリアボタン用 */
    .btn-ghost{
      border-radius:var(--radius-pill);
      padding:10px 20px;
      border:1px dashed var(--border);
      background:transparent;
      font-size:14px;
      color:var(--muted);
      cursor:pointer;
      display: flex;
      justify-content: center;
      align-items: center;
    }

    /* ========== 下部ボタン ========== */
    .action-buttons {
      display: flex;
      gap: 12px;
      justify-content: flex-start;
      flex-wrap: wrap;
      width: 100%;
    }
    .btn-soft {
      flex: 1;
      min-width: 120px;
      border: 1px solid var(--btn-soft-border);
      background: var(--btn-soft-bg);
      color: var(--btn-soft-text);
      border-radius: 8px;
      padding: 14px;
      font-size: 15px;
      font-weight: 700;
      cursor: pointer;
      text-align: center;
      transition: all 0.2s ease;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    .btn-soft:hover {
      background: #e2f1f5;
      transform: translateY(-1px);
    }
    .btn-soft:active {
      transform: scale(0.98);
    }
    .btn-outline {
      flex: 1;
      min-width: 140px;
      border: 2px solid var(--btn-outline-border);
      background: #fff;
      color: var(--btn-outline-border);
      border-radius: 8px;
      padding: 13px;
      font-size: 15px;
      font-weight: 700;
      cursor: pointer;
      text-align: center;
      transition: all 0.2s ease;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    .btn-outline:hover {
      background: #f0fcfd;
      transform: translateY(-1px);
    }
    .btn-outline:active {
      transform: scale(0.98);
    }

    .result-card{
      border-left:4px solid var(--accent);
    }
    .result-grid{
      display:grid;
      gap:12px 16px;
    }
    @media(min-width:800px){
      .result-grid{
        grid-template-columns:repeat(2,minmax(0,1fr));
      }
    }
    .metric{
      padding:12px 16px;
      border-radius:12px;
      background:var(--accent-soft);
      border:1px solid rgba(87,136,153,.16);
    }
    
    .metric-featured {
      background: #fff;
      border: 2px solid var(--accent);
      box-shadow: 0 4px 12px rgba(87,136,153,.15);
    }
    .metric-featured .metric-label {
      color: var(--accent);
      font-weight: 700;
    }
    .metric-featured .metric-value {
      font-size: 24px;
      color: var(--accent);
      line-height: 1.3;
    }

    .metric-label{
      font-size:13px;
      color:var(--muted);
      margin-bottom:4px;
    }
    .metric-value{
      font-size:20px;
      font-weight:700;
      color:var(--ink);
    }
    .metric-sub{
      font-size:12px;
      color:var(--muted);
      margin-top:2px;
    }
    .result-heading{
      font-size:16px;
      font-weight:700;
      margin:0 0 8px;
    }
    .note-card ul{
      margin:6px 0 0 20px;
      padding:0;
      font-size:13px;
      color:var(--muted);
    }
    .note-card li{margin-bottom:6px;}
    .note-highlight{
      border-radius:10px;
      padding:12px;
      background:#fffbe8;
      border:1px solid #f5e2a0;
      font-size:13px;
      color:#6a4c0a;
      margin-top:12px;
      line-height: 1.6;
    }
    .app-footer{
      padding:20px;
      text-align:center;
      font-size:12px;
      color:var(--muted);
    }
    .hidden{display:none!important;}
    
    /* チュートリアルボタン */
    .btn-tutorial{
      appearance:none;
      border:1px solid var(--border);
      background:#ffffff;
      border-radius:12px;
      padding:8px 14px;
      font-weight:700;
      cursor:pointer;
      color:var(--accent);
      font-size:13px;
      box-shadow:0 4px 10px rgba(15,23,42,.06);
      white-space:nowrap;
      transition:background .12s ease,box-shadow .12s ease,transform .12s ease,border-color .12s ease;
      flex-shrink: 0;
    }
    .btn-tutorial:hover{
      border-color:#94a3b8;
      background:#f8fafc;
      transform:translateY(-1px);
      box-shadow:0 6px 14px rgba(15,23,42,.10);
    }

    /* --- フッター（ミニ版） --- */
    footer.mk-mini{
      margin:16px 0 16px;
      font-size:12px;
      color:#334155;
      display:flex;
      justify-content:center;
      gap:10px;
      flex-wrap:wrap;
      line-height: 1.6;
    }
    footer.mk-mini a{
      color:inherit;
      text-decoration:underline;
      text-underline-offset:2px;
    }

    /* ===== チュートリアル関連 ===== */
    .mk-tour-mask{
      position:fixed;inset:0;background:rgba(15,23,42,.56);
      backdrop-filter:saturate(120%) blur(2px);
      z-index:9998;
    }
    .mk-tour-focus{
      position:fixed;border-radius:12px;
      box-shadow:0 0 0 3px #fff, 0 0 0 6px rgba(87,136,153,.35), 0 10px 30px rgba(0,0,0,.35);
      z-index:10001;
      pointer-events:none;transition:transform .2s ease, width .2s ease, height .2s ease, left .2s ease, top .2s ease;
    }
    .mk-tour-panel{
      position:fixed;z-index:10002;
      max-width:min(560px, 92vw);background:#fff;border:1px solid var(--border);border-radius:16px;
      box-shadow:0 14px 36px rgba(0,0,0,.22);padding:16px;
    }
    .mk-tour-head{display:flex;align-items:center;gap:8px;margin-bottom:8px}
    .mk-tour-step{font-size:12px;color:#475569}
    .mk-tour-title{font-weight:800;font-size:15px}
    .mk-tour-body{font-size:14px;color:var(--ink);line-height:1.5}
    .mk-tour-actions{display:flex;justify-content:flex-end;gap:8px;margin-top:12px}
    .mk-tour-actions .tbtn{border-radius:10px;border:1px solid var(--border);background:#fff;padding:8px 14px;font-weight:700;cursor:pointer;font-size:13px}
    .mk-tour-actions .tbtn.primary{background:var(--accent);border-color:var(--accent);color:#fff}
    .mk-tour-actions .tbtn:disabled{opacity:.55;cursor:not-allowed}
    .mk-tour-elevate{
      position:relative !important;
      z-index:10000 !important;
      isolation:isolate;
    }
    @media(max-width:600px){
      .mk-tour-panel{left:12px;right:12px;max-width:calc(100vw - 24px);}
    }

    /* =========================================
       スマホ表示最適化 (Mobile Optimization)
       ========================================= */
    @media (max-width: 600px) {
      .layout {
        padding: 12px;
      }
      .app-header {
        padding: 10px 12px;
      }
      .brand-logo {
        height: 36px;
      }
      .brand-title {
        font-size: 18px;
      }
      .brand-subtitle {
        display: none;
      }
      .card {
        padding: 16px;
        margin-bottom: 12px;
      }
      .pill-switch {
        width: 100%;
        display: flex;
      }
      .pill-switch label {
        flex: 1;
        padding: 10px 4px;
        font-size: 14px;
      }
      input[type="text"], input[type="number"], select {
        font-size: 16px;
        padding: 12px;
      }
      .btn-row {
        flex-direction: column;
        align-items: stretch;
        gap: 12px;
      }
      .btn-calc {
        width: 100%;
        justify-content: center;
        padding: 14px;
      }
      .btn-ghost {
        width: 100%;
        padding: 12px;
      }
      .action-buttons {
        flex-direction: row;
        flex-wrap: nowrap;
        gap: 8px;
      }
      .btn-soft, .btn-outline {
        width: auto;
        flex: 1;
        min-width: 0;
        padding: 12px 4px;
        font-size: 12px;
      }
      .radio-row {
        gap: 8px;
      }
      .radio-chip {
        padding: 10px 14px;
        font-size: 13px;
      }
    }
  </style>
</head>
<body>
<div class="app">
  <header class="app-header">
    <div class="header-bar">
      <a href="https://takatrp.github.io/tool-portal/" class="brand">
        <img src="./logo.jpg" alt="税理士法人松本会計事務所" class="brand-logo" />
        <div class="brand-text">
          <h1 class="brand-title">贈与税試算ツール</h1>
          <p class="brand-subtitle">暦年課税（一般・特例）／相続時精算課税／長期シミュレーション（概算）</p>
        </div>
      </a>
      <button type="button" class="btn-tutorial" id="startTour">チュートリアル</button>
    </div>
  </header>

  <main class="layout">

    <section class="card">
      <div class="card-header">
        <h2 class="card-title">モード選択</h2>
      </div>
      <div class="card-body">
        <div class="pill-switch" id="tabSwitch">
          <label>
            <input type="radio" name="tabMode" value="single" checked>
            <span>単年試算（1年分の贈与税）</span>
          </label>
          <label>
            <input type="radio" name="tabMode" value="multi">
            <span>長期シミュレーション（暦年 vs 精算）</span>
          </label>
        </div>
        <small>
          単年試算タブでは「1人の受贈者について1年間の贈与税額」を、長期シミュレーションタブでは
          「相続財産・相続までの年数・毎年の贈与額等」を前提とした暦年課税 vs 相続時精算課税の概算比較を行います。
        </small>
      </div>
    </section>

    <div id="singleModeArea">
      <section class="card">
        <div class="card-header">
          <h2 class="card-title">STEP1 計算方法の選択</h2>
          <div class="badge">令和7年4月1日現在法令等ベース</div>
        </div>
        <div class="card-body">
          <div class="field">
            <label>試算したい贈与税の計算方法</label>
            <div class="pill-switch" id="modeSwitch">
              <label>
                <input type="radio" name="mode" value="annual" checked>
                <span>暦年課税（一般・特例）</span>
              </label>
              <label>
                <input type="radio" name="mode" value="seisan">
                <span>相続時精算課税</span>
              </label>
            </div>
            <small>※ 本タブは 1人の受贈者について、1年間の贈与額を前提としています（申告書作成時は国税庁様式でご確認ください）。</small>
          </div>
        </div>
      </section>

      <section class="card" id="annualCard">
        <div class="card-header">
          <h2 class="card-title">STEP2-Ａ 暦年課税の入力</h2>
        </div>
        <div class="card-body">
          <div class="field">
            <label>贈与の区分</label>
            <div class="radio-row">
              <label class="radio-chip">
                <input type="radio" name="annualMode" value="general" checked />
                <span>一般贈与財産のみ</span>
              </label>
              <label class="radio-chip">
                <input type="radio" name="annualMode" value="special" />
                <span>特例贈与財産のみ（直系尊属→18歳以上の子・孫など）</span>
              </label>
              <label class="radio-chip">
                <input type="radio" name="annualMode" value="both" />
                <span>一般＋特例の両方あり</span>
              </label>
            </div>
            <small>※ 特例贈与財産に該当するかどうかは、受贈者の年齢（1月1日時点18歳以上）と贈与者との関係（直系尊属かどうか）で判定されます。</small>
          </div>

          <div class="grid grid-2" style="margin-top:10px;" id="annualInputs">
            <div class="field annual-group annual-general-only" id="annualGeneralOnly">
              <label>一般贈与財産の年間贈与額</label>
              <input type="text" inputmode="numeric" id="annualGeneralAmount" placeholder="例）3,000,000" class="yen-input" />
              <small>兄弟姉妹・配偶者などからの贈与、または18歳未満の子・孫への贈与など。</small>
            </div>
            <div class="field annual-group annual-special-only hidden" id="annualSpecialOnly">
              <label>特例贈与財産の年間贈与額</label>
              <input type="text" inputmode="numeric" id="annualSpecialAmount" placeholder="例）4,000,000" class="yen-input" />
              <small>18歳以上の子・孫などが、父母・祖父母から受ける贈与（住宅取得資金等の特例は含みません）。</small>
            </div>
            <div class="field annual-group annual-both hidden" id="annualBothGeneral">
              <label>一般贈与財産の年間贈与額（一般＋特例）</label>
              <input type="text" inputmode="numeric" id="annualGeneralAmountBoth" placeholder="例）1,000,000" class="yen-input" />
              <small>配偶者・兄弟姉妹などからの贈与分。</small>
            </div>
            <div class="field annual-group annual-both hidden" id="annualBothSpecial">
              <label>特例贈与財産の年間贈与額（一般＋特例）</label>
              <input type="text" inputmode="numeric" id="annualSpecialAmountBoth" placeholder="例）4,000,000" class="yen-input" />
              <small>直系尊属からの贈与分。</small>
            </div>
          </div>

          <div class="btn-row">
            <button type="button" class="btn-calc" id="calcAnnualBtn">
              <span class="btn-calc-icon">▶</span>
              <span>暦年課税で試算する</span>
            </button>
            <button type="button" class="btn-ghost" id="annualClear">入力をクリア</button>
          </div>
        </div>
      </section>

      <section class="card hidden" id="seisanCard">
        <div class="card-header">
          <h2 class="card-title">STEP2-Ｂ 相続時精算課税の入力</h2>
        </div>
        <div class="card-body">
          <div class="grid grid-2">
            <div class="field">
              <label>今年 1年間の贈与額（特定贈与者 1人分）</label>
              <input type="text" inputmode="numeric" id="seisanAmount" placeholder="例）5,000,000" class="yen-input" />
              <small>※父・母など、精算課税を選択した「特定の贈与者1名」からの贈与額を入力してください。複数人から受けている場合は個別に計算が必要です。</small>
            </div>
            <div class="field">
              <label>前年までに使用済みの特別控除額</label>
              <input type="text" inputmode="numeric" id="seisanUsedSpecial" placeholder="例）12,000,000" class="yen-input" />
              <small>2,500万円の特別控除のうち、既に控除に使った累計額（0〜25,000,000）。</small>
            </div>
          </div>
          <div class="btn-row">
            <button type="button" class="btn-calc" id="calcSeisanBtn">
              <span class="btn-calc-icon">▶</span>
              <span>相続時精算課税で試算する</span>
            </button>
            <button type="button" class="btn-ghost" id="seisanClear">入力をクリア</button>
          </div>
        </div>
      </section>

      <section class="card result-card" id="resultCard">
        <div class="card-header">
          <h2 class="card-title">STEP3 試算結果</h2>
        </div>
        <div class="card-body">
          <p id="resultSummary" class="result-heading">入力内容をもとに、贈与税額を概算しています。</p>
          <div class="result-grid">
            <div class="metric metric-featured">
              <div class="metric-label">概算贈与税額</div>
              <div class="metric-value" id="resultTax">- 円</div>
              <div class="metric-sub" id="resultTaxSub">（100円未満切捨て）</div>
            </div>
            <div class="metric">
              <div class="metric-label">基礎控除後の課税価格</div>
              <div class="metric-value" id="resultBase">- 円</div>
              <div class="metric-sub" id="resultBaseSub">贈与総額 − 110万円</div>
            </div>
            <div class="metric" id="metricRate">
              <div class="metric-label">適用税率・控除額（暦年課税）</div>
              <div class="metric-value" id="resultRate">-</div>
              <div class="metric-sub" id="resultRateSub">一般／特例ごとの速算表に基づき計算</div>
            </div>
            <div class="metric" id="metricSeisan">
              <div class="metric-label">相続時精算課税：当年の特別控除利用額</div>
              <div class="metric-value" id="resultSeisanSpecial">- 円</div>
              <div class="metric-sub" id="resultSeisanSub">累計特別控除利用額：<span id="resultSeisanUsedTotal">- 円</span></div>
            </div>
          </div>
        </div>
      </section>
    </div>

    <div id="multiModeArea" class="hidden">
      <section class="card" id="multiCommonCard">
        <div class="card-header">
          <h2 class="card-title">STEP1 長期シミュレーションの前提条件</h2>
        </div>
        <div class="card-body">
          <div class="grid grid-2">
            <div class="field">
              <label>現在の相続財産総額（贈与前）</label>
              <input type="text" inputmode="numeric" id="multiEstateTotal" placeholder="例）150,000,000" class="yen-input" />
              <small>預金・有価証券・不動産など、相続財産となる資産の概算合計額。</small>
            </div>
            <div class="field">
              <label>相続までの想定年数（シミュレーション期間）</label>
              <input type="number" id="multiYears" class="align-left" placeholder="例）15" min="1" step="1" />
              <small>「あと○年程度で相続が発生する」と想定する年数。概算で構いません。</small>
            </div>
          </div>
          <div class="grid grid-2" style="margin-top:12px;">
            <div class="field">
              <label>年間運用利回り（％）</label>
              <input type="number" id="multiReturnRate" class="align-left" placeholder="例）1.0" step="0.1" />
              <small>相続財産全体の平均的な増減率（0％とすれば運用を考慮しません）。</small>
            </div>
            <div class="field">
              <label>想定相続税実効税率（％）</label>
              <input type="number" id="multiEffRate" class="align-left" placeholder="例）20" step="1" />
              <small>厳密な相続税計算の代わりに、課税ベースに乗じる概算の税率（例：20〜30％）。</small>
            </div>
          </div>
        </div>
      </section>

      <section class="card" id="multiAnnualCard">
        <div class="card-header">
          <h2 class="card-title">STEP2-A 暦年贈与シナリオ（毎年コツコツ型）</h2>
        </div>
        <div class="card-body">
          <div class="grid grid-2">
            <div class="field">
              <label>1人あたり毎年の贈与額</label>
              <input type="text" inputmode="numeric" id="multiAnnualGiftPerPerson" placeholder="例）3,000,000" class="yen-input" />
              <small>特例贈与財産（直系尊属→18歳以上の子・孫）を前提に、1人あたり毎年いくら贈与するかを入力します。</small>
            </div>
            <div class="field">
              <label>受贈者の人数</label>
              <input type="number" id="multiAnnualRecipients" class="align-left" placeholder="例）2" min="1" step="1" />
              <small>同じ金額を受け取る子・孫の人数（例：子2人なら「2」）。</small>
            </div>
          </div>
          <small>
            ※ 暦年贈与シナリオでは、毎年同額を特例贈与として贈与する前提で、贈与税は特例税率（子・孫が18歳以上）で概算します。
          </small>
        </div>
      </section>

      <section class="card" id="multiSeisanCard">
        <div class="card-header">
          <h2 class="card-title">STEP2-B 相続時精算課税シナリオ（まとめて移転型）</h2>
        </div>
        <div class="card-body">
          <div class="grid grid-2">
            <div class="field">
              <label>シミュレーション開始時にまとめて贈与する額</label>
              <input type="text" inputmode="numeric" id="multiSeisanInitialGift" placeholder="例）25,000,000" class="yen-input" />
              <small>相続時精算課税を選択して一括移転する額（自宅・賃貸不動産・まとまった金融資産など）。0円も可。</small>
            </div>
            <div class="field">
              <label>2年目以降、毎年贈与する額</label>
              <input type="text" inputmode="numeric" id="multiSeisanAnnualGift" placeholder="例）1,100,000" class="yen-input" />
              <small>相続時精算課税の贈与者 1人から、その受贈者 1人へ毎年贈与する額。110万円以下なら申告不要・加算対象外。</small>
            </div>
          </div>
          <div class="grid grid-2" style="margin-top:12px;">
            <div class="field">
              <label>既に使用済みの特別控除額</label>
              <input type="text" inputmode="numeric" id="multiSeisanUsedSpecialBefore" placeholder="例）0" class="yen-input" />
              <small>当該贈与者について、これまでに相続時精算課税で使った特別控除額（0〜25,000,000）。</small>
            </div>
          </div>
          <div class="btn-row">
            <button type="button" class="btn-calc" id="runMultiSimBtn">
              <span class="btn-calc-icon">▶</span>
              <span>長期シミュレーションを実行</span>
            </button>
            <button type="button" class="btn-ghost" id="multiClearBtn">入力をクリア</button>
          </div>
        </div>
      </section>

      <section class="card result-card hidden" id="multiResultCard">
        <div class="card-header">
          <h2 class="card-title">STEP3 長期シミュレーション結果（概算）</h2>
        </div>
        <div class="card-body">
          <p id="multiResultSummary" class="result-heading">前提条件と各シナリオの設定をもとに、暦年贈与シナリオと相続時精算課税シナリオの税負担・残財産を概算しています。</p>
          <div class="result-grid">
            <div class="metric">
              <div class="metric-label">暦年贈与シナリオ：トータル税負担</div>
              <div class="metric-value" id="multiAnnualTotalTax">- 円</div>
              <div class="metric-sub">贈与税＋相続税（概算）の合計</div>
            </div>
            <div class="metric">
              <div class="metric-label">暦年贈与シナリオ：相続時点の残財産</div>
              <div class="metric-value" id="multiAnnualFinalEstate">- 円</div>
              <div class="metric-sub">贈与後・運用後に残る相続財産（概算）</div>
            </div>
            <div class="metric">
              <div class="metric-label">相続時精算課税シナリオ：トータル税負担</div>
              <div class="metric-value" id="multiSeisanTotalTax">- 円</div>
              <div class="metric-sub">贈与税＋相続税（相続時精算課税分控除後）の合計</div>
            </div>
            <div class="metric">
              <div class="metric-label">相続時精算課税シナリオ：相続時点の残財産</div>
              <div class="metric-value" id="multiSeisanFinalEstate">- 円</div>
              <div class="metric-sub">贈与後・運用後に残る相続財産（概算）</div>
            </div>
            <div class="metric metric-featured">
              <div class="metric-label">税負担の差額（暦年 − 精算）</div>
              <div class="metric-value" id="multiTaxDiff">- 円</div>
              <div class="metric-sub" id="multiTaxDiffSub">プラスなら相続時精算課税シナリオの方が税負担が軽い結果です。</div>
            </div>
          </div>
        </div>
      </section>
    </div>

    <section class="card note-card" id="noteCard">
      <div class="card-header">
        <h2 class="card-title">ご利用上の注意</h2>
      </div>
      <div class="card-body">
        <ul>
          <li>本ツールは、令和7年4月1日現在の国税庁タックスアンサー（No.4408「贈与税の計算と税率（暦年課税）」、No.4103「相続時精算課税の選択」など）に基づき、贈与税額を概算するためのものです。</li>
          <li>土地・建物、有価証券の評価、各種非課税枠（配偶者控除、住宅取得資金の非課税、教育資金一括贈与 等）、特例税率の適用判定、相続税への生前贈与加算の詳細（7年加算・経過措置・100万円控除 等）については、本ツールでは簡略化しており、別途の検討が必要です。</li>
          <li>相続時精算課税については、令和6年1月1日以後の贈与に創設された年110万円の基礎控除と、累計2,500万円の特別控除を前提としています。</li>
          <li>長期シミュレーションの暦年贈与における相続財産への加算期間は、経過措置を考慮せず一律「相続前7年間」として概算しています。</li>
          <li>長期シミュレーションでは、相続税は「想定相続税実効税率」を用いた概算であり、実際の相続税計算結果とは異なる場合があります。</li>
        </ul>
        <div class="note-highlight">
          本ツールは税額の「概算」を把握することを目的としたものであり、申告書作成や申告是非の判断を直接行うものではありません。実務では、贈与の内容・時期・受贈者・贈与者の関係などを総合的に確認する必要があります。実際の贈与の実行・申告にあたっては、松本会計のスタッフにご相談ください。
        </div>
      </div>
    </section>

    <section class="card" id="bottomActions">
      <div class="card-body">
        <div class="action-buttons">
          <button type="button" class="btn-soft" id="copyResultBtn">コピー</button>
          <button type="button" class="btn-soft" id="resetAllBtn">リセット</button>
          <button type="button" class="btn-outline" id="printBtn">印刷 / PDF保存</button>
        </div>
      </div>
    </section>

  </main>

  <footer class="mk-mini">
    © <span id="cpy-year">2025</span>
    <a href="https://www.matsumoto-kaikei.or.jp/" target="_blank" rel="noopener license">税理士法人松本会計事務所</a> ｜ 
    <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" target="_blank" rel="license noopener">CC BY-NC-SA 4.0</a> ｜ 
    <a href="/tool-portal/terms.html" target="_blank" rel="noopener">利用条件</a> ｜ 
    <span id="build-rev">r4</span>（<span id="last-updated-date"></span>）
  </footer>
</div>

<script>
(function(){
  'use strict';

  const VERSION = 'r4';

  // 年号 & 最終更新日を自動反映
  (function syncFooterMeta(){
    const yEl = document.getElementById('cpy-year');
    const dEl = document.getElementById('last-updated-date');
    const rEl = document.getElementById('build-rev');
    if(yEl){ yEl.textContent = String(new Date().getFullYear()); }
    if(dEl){
      const d = new Date(document.lastModified);
      const yyyy = String(d.getFullYear());
      const mm = String(d.getMonth()+1).padStart(2,'0');
      const dd = String(d.getDate()).padStart(2,'0');
      dEl.textContent = `${yyyy}-${mm}-${dd}`;
    }
    if(rEl){ rEl.textContent = VERSION; }
  })();

  // 定数
  const BASE_DEDUCTION = 1100000; // 暦年課税・相続時精算課税 共通の基礎控除額（110万円）
  const SEISAN_SPECIAL_LIMIT = 25000000; // 相続時精算課税の特別控除限度額（2,500万円）

  // 速算表
  const GENERAL_BRACKETS = [
    { upTo: 2000000, rate: 0.10, deduction: 0 },
    { upTo: 3000000, rate: 0.15, deduction: 100000 },
    { upTo: 4000000, rate: 0.20, deduction: 250000 },
    { upTo: 6000000, rate: 0.30, deduction: 650000 },
    { upTo: 10000000, rate: 0.40, deduction: 1250000 },
    { upTo: 15000000, rate: 0.45, deduction: 1750000 },
    { upTo: 30000000, rate: 0.50, deduction: 2500000 },
    { upTo: Infinity, rate: 0.55, deduction: 4000000 }
  ];

  const SPECIAL_BRACKETS = [
    { upTo: 2000000, rate: 0.10, deduction: 0 },
    { upTo: 4000000, rate: 0.15, deduction: 100000 },
    { upTo: 6000000, rate: 0.20, deduction: 300000 },
    { upTo: 10000000, rate: 0.30, deduction: 900000 },
    { upTo: 15000000, rate: 0.40, deduction: 1900000 },
    { upTo: 30000000, rate: 0.45, deduction: 2650000 },
    { upTo: 45000000, rate: 0.50, deduction: 4150000 },
    { upTo: Infinity, rate: 0.55, deduction: 6400000 }
  ];

  // DOM取得（単年タブ）
  const modeRadios = document.querySelectorAll('input[name="mode"]');
  const annualCard = document.getElementById('annualCard');
  const seisanCard = document.getElementById('seisanCard');

  const annualModeRadios = document.querySelectorAll('input[name="annualMode"]');
  const annualGeneralOnly = document.getElementById('annualGeneralOnly');
  const annualSpecialOnly = document.getElementById('annualSpecialOnly');
  const annualBothGeneral = document.getElementById('annualBothGeneral');
  const annualBothSpecial = document.getElementById('annualBothSpecial');

  const annualGeneralAmount = document.getElementById('annualGeneralAmount');
  const annualSpecialAmount = document.getElementById('annualSpecialAmount');
  const annualGeneralAmountBoth = document.getElementById('annualGeneralAmountBoth');
  const annualSpecialAmountBoth = document.getElementById('annualSpecialAmountBoth');

  const seisanAmount = document.getElementById('seisanAmount');
  const seisanUsedSpecial = document.getElementById('seisanUsedSpecial');

  const calcAnnualBtn = document.getElementById('calcAnnualBtn');
  const calcSeisanBtn = document.getElementById('calcSeisanBtn');
  const annualClear = document.getElementById('annualClear');
  const seisanClear = document.getElementById('seisanClear');

  const resultSummary = document.getElementById('resultSummary');
  const resultTax = document.getElementById('resultTax');
  const resultTaxSub = document.getElementById('resultTaxSub');
  const resultBase = document.getElementById('resultBase');
  const resultBaseSub = document.getElementById('resultBaseSub');
  const resultRate = document.getElementById('resultRate');
  const resultRateSub = document.getElementById('resultRateSub');
  const metricRate = document.getElementById('metricRate');
  const metricSeisan = document.getElementById('metricSeisan');
  const resultSeisanSpecial = document.getElementById('resultSeisanSpecial');
  const resultSeisanUsedTotal = document.getElementById('resultSeisanUsedTotal');
  const resultSeisanSub = document.getElementById('resultSeisanSub');

  const copyResultBtn = document.getElementById('copyResultBtn');
  const resetAllBtn = document.getElementById('resetAllBtn');
  const printBtn = document.getElementById('printBtn');

  // タブ切替用DOM
  const tabModeRadios = document.querySelectorAll('input[name="tabMode"]');
  const singleModeArea = document.getElementById('singleModeArea');
  const multiModeArea = document.getElementById('multiModeArea');

  // 長期シミュレーション用DOM
  const multiEstateTotal = document.getElementById('multiEstateTotal');
  const multiYears = document.getElementById('multiYears');
  const multiReturnRate = document.getElementById('multiReturnRate');
  const multiEffRate = document.getElementById('multiEffRate');

  const multiAnnualGiftPerPerson = document.getElementById('multiAnnualGiftPerPerson');
  const multiAnnualRecipients = document.getElementById('multiAnnualRecipients');

  const multiSeisanInitialGift = document.getElementById('multiSeisanInitialGift');
  const multiSeisanAnnualGift = document.getElementById('multiSeisanAnnualGift');
  const multiSeisanUsedSpecialBefore = document.getElementById('multiSeisanUsedSpecialBefore');

  const runMultiSimBtn = document.getElementById('runMultiSimBtn');
  const multiClearBtn = document.getElementById('multiClearBtn');
  const multiResultCard = document.getElementById('multiResultCard');

  const multiResultSummary = document.getElementById('multiResultSummary');
  const multiAnnualTotalTax = document.getElementById('multiAnnualTotalTax');
  const multiAnnualFinalEstate = document.getElementById('multiAnnualFinalEstate');
  const multiSeisanTotalTax = document.getElementById('multiSeisanTotalTax');
  const multiSeisanFinalEstate = document.getElementById('multiSeisanFinalEstate');
  const multiTaxDiff = document.getElementById('multiTaxDiff');
  const multiTaxDiffSub = document.getElementById('multiTaxDiffSub');

  // 全ての金額入力欄（カンマ整形）
  const yenInputs = document.querySelectorAll('.yen-input');

  // リアルタイムカンマ表示ロジック（修正：IME対応強化）
  yenInputs.forEach(input => {
    let isComposing = false;
    input.addEventListener('compositionstart', () => { isComposing = true; });
    input.addEventListener('compositionend', () => { 
      isComposing = false; 
      input.dispatchEvent(new Event('input')); 
    });

    input.addEventListener('input', function(){
      if(isComposing) return; // 変換中は処理しない
      const cursor = this.selectionStart;
      const val = this.value;
      const digitsBeforeCursor = (val.slice(0, cursor).match(/[0-9]/g) || []).length;
      const raw = val.replace(/[^0-9]/g, '');
      if (!raw) {
        this.value = '';
        return;
      }
      const formatted = Number(raw).toLocaleString('ja-JP');
      this.value = formatted;
      let newCursor = 0;
      let digitsSeen = 0;
      for (let i = 0; i < formatted.length; i++) {
        if (/[0-9]/.test(formatted[i])) {
          digitsSeen++;
        }
        if (digitsSeen === digitsBeforeCursor) {
          newCursor = i + 1;
          break;
        }
      }
      if (digitsBeforeCursor === 0) newCursor = 0;
      this.setSelectionRange(newCursor, newCursor);
    });
  });

  // ユーティリティ
  function parseYenInput(el){
    if(!el) return 0;
    const raw = (el.value || '').replace(/[\s,]/g,'');
    if(!raw) return 0;
    const n = Number(raw);
    return Number.isFinite(n) ? Math.floor(n) : 0;
  }

  function formatYen(n){
    if(!Number.isFinite(n)) return '-';
    return n.toLocaleString('ja-JP');
  }

  function roundTax100(n){
    if(!Number.isFinite(n) || n <= 0) return 0;
    return Math.floor(n / 100) * 100;
  }

  // 課税価格の千円未満切捨て
  function truncateToThousand(n){
    if(!Number.isFinite(n) || n <= 0) return 0;
    return Math.floor(n / 1000) * 1000;
  }

  function calcTaxFromTable(taxBase, brackets){
    if(taxBase <= 0) return { tax:0, rate:null, deduction:null };
    const b = brackets.find(br => taxBase <= br.upTo) || brackets[brackets.length - 1];
    const tax = taxBase * b.rate - b.deduction;
    return { tax: tax, rate: b.rate, deduction: b.deduction };
  }

  function parseNumber(el, defaultValue){
    if(!el) return defaultValue;
    const val = String(el.value || '').trim();
    if(!val) return defaultValue;
    const n = Number(val);
    return Number.isFinite(n) ? n : defaultValue;
  }

  // ===== チュートリアル（既存） =====
  const TOUR_KEY = 'gift_tax_tour_dismissed_v1';
  const steps = [
    {
      sel: '.brand',
      title: 'ツール概要',
      body: 'このツールでは、暦年課税（一般・特例）と相続時精算課税について、1人の受贈者あたり1年間の贈与税額を概算でき、長期シミュレーションタブでは暦年贈与と相続時精算課税の有利不利を概算比較できます。'
    },
    {
      sel: '#tabSwitch',
      title: 'モード選択',
      body: '「単年試算」と「長期シミュレーション」をタブ形式で切り替えます。まずはどちらを使うかを選択してください。'
    },
    {
      sel: '#modeSwitch',
      title: '単年試算：計算方法の選択',
      body: '単年試算タブでは、暦年課税か相続時精算課税かを選択し、1年分の贈与税額を概算します。'
    },
    {
      sel: '#multiCommonCard',
      title: '長期シミュレーション：前提条件',
      body: '長期シミュレーションタブでは、相続財産総額や相続までの年数、運用利回り、想定相続税実効税率などを入力してシミュレーションを行います。'
    },
    {
      sel: '#resultCard',
      title: '単年試算：結果表示',
      body: '単年試算では、概算贈与税額・課税価格・適用税率や相続時精算課税の特別控除利用状況などが表示されます。'
    },
    {
      sel: '#multiResultCard',
      title: '長期シミュレーション：結果表示',
      body: '長期シミュレーション結果では、暦年贈与シナリオと相続時精算課税シナリオの税負担・残財産・税負担の差額を確認できます。'
    }
  ];

  let tourIndex = 0;
  let maskEl, focusEl, panelEl, prevBtn, nextBtn, skipBtn, titleEl2, bodyEl2, stepEl2;
  let elevatedEl = null;

  const qs = sel => document.querySelector(sel);
  const vv = () => window.visualViewport || null;
  const vvOffsetX = () => { const v = vv(); return v ? v.offsetLeft : 0; };
  const vvOffsetY = () => { const v = vv(); return v ? v.offsetTop : 0; };
  const vvWidth = () => { const v = vv(); return v ? v.width : window.innerWidth; };
  const vvHeight = () => { const v = vv(); return v ? v.height : window.innerHeight; };

  function stableScrollIntoView(el){
    return new Promise(resolve => {
      if(!el){ resolve(); return; }
      let done = false;
      const timer = setTimeout(() => {
        if(done) return;
        done = true;
        resolve();
      }, 350);
      const finish = () => {
        if(done) return;
        done = true;
        clearTimeout(timer);
        resolve();
      };
      const onEnd = () => {
        window.removeEventListener('scrollend', onEnd);
        finish();
      };
      window.addEventListener('scrollend', onEnd, { once:true });
      el.scrollIntoView({ block:'center', behavior:'smooth' });
      requestAnimationFrame(() => requestAnimationFrame(() => {}));
    });
  }

  function rectInVisualViewport(el){
    const r = el.getBoundingClientRect();
    const x = Math.round(r.left + vvOffsetX());
    const y = Math.round(r.top + vvOffsetY());
    const w = Math.round(Math.min(r.width, vvWidth() - 16));
    const h = Math.round(Math.min(r.height, vvHeight() - 16));
    const pad = 8;
    return {
      x: Math.max(8 + vvOffsetX(), x - pad),
      y: Math.max(8 + vvOffsetY(), y - pad),
      w: Math.max(24, w + pad * 2),
      h: Math.max(24, h + pad * 2)
    };
  }

  function placeFocus(){
    if(!panelEl || !focusEl) return;
    const step = steps[tourIndex];

    if(step.sel === '#modeSwitch'){
      const r = document.querySelector('input[name="tabMode"][value="single"]');
      if(r && !r.checked){ r.checked = true; updateTabMode(); }
      const r2 = document.querySelector('input[name="mode"][value="annual"]');
      if(r2 && !r2.checked){ r2.checked = true; updateMode(); }
    }else if(step.sel === '#multiCommonCard'){
      const r = document.querySelector('input[name="tabMode"][value="multi"]');
      if(r && !r.checked){ r.checked = true; updateTabMode(); }
    }

    const target = qs(step.sel);
    if(!target) return;

    if(elevatedEl && elevatedEl !== target){
      elevatedEl.classList.remove('mk-tour-elevate');
    }
    target.classList.add('mk-tour-elevate');
    elevatedEl = target;

    const rct = rectInVisualViewport(target);
    focusEl.style.left = rct.x + 'px';
    focusEl.style.top = rct.y + 'px';
    focusEl.style.width = rct.w + 'px';
    focusEl.style.height = rct.h + 'px';

    const panelW = Math.min(560, vvWidth() * 0.92);
    const margin = 12;
    const belowY = rct.y + rct.h + margin;
    const aboveY = Math.max(8 + vvOffsetY(), rct.y - margin - 170);
    let px = Math.min(Math.max(8 + vvOffsetX(), rct.x), vvOffsetX() + vvWidth() - panelW - 8);
    let py = (belowY + 190 < vvOffsetY() + vvHeight()) ? belowY : aboveY;

    panelEl.style.left = px + 'px';
    panelEl.style.top = py + 'px';
    panelEl.style.maxWidth = panelW + 'px';

    stepEl2.textContent = 'STEP ' + (tourIndex + 1) + ' / ' + steps.length;
    titleEl2.textContent = step.title;
    bodyEl2.innerHTML = step.body;

    prevBtn.disabled = tourIndex === 0;
    nextBtn.textContent = (tourIndex === steps.length - 1) ? '完了' : '次へ';
  }

  function ensureEls(){
    if(maskEl) return;
    maskEl = document.createElement('div');
    maskEl.className = 'mk-tour-mask';
    maskEl.tabIndex = -1;
    focusEl = document.createElement('div');
    focusEl.className = 'mk-tour-focus';
    focusEl.setAttribute('aria-hidden','true');
    panelEl = document.createElement('div');
    panelEl.className = 'mk-tour-panel';
    const head = document.createElement('div');
    head.className = 'mk-tour-head';
    stepEl2 = document.createElement('div');
    stepEl2.className = 'mk-tour-step';
    titleEl2 = document.createElement('div');
    titleEl2.className = 'mk-tour-title';
    head.append(stepEl2, titleEl2);
    bodyEl2 = document.createElement('div');
    bodyEl2.className = 'mk-tour-body';
    const actions = document.createElement('div');
    actions.className = 'mk-tour-actions';
    prevBtn = document.createElement('button');
    prevBtn.className = 'tbtn';
    prevBtn.textContent = '前へ';
    skipBtn = document.createElement('button');
    skipBtn.className = 'tbtn';
    skipBtn.textContent = 'スキップ';
    nextBtn = document.createElement('button');
    nextBtn.className = 'tbtn primary';
    nextBtn.textContent = '次へ';
    actions.append(prevBtn, skipBtn, nextBtn);
    panelEl.append(head, bodyEl2, actions);
    document.body.append(maskEl, focusEl, panelEl);

    skipBtn.addEventListener('click', endTour);
    prevBtn.addEventListener('click', async () => {
      if(tourIndex > 0){
        tourIndex--;
        placeFocus();
        await stableScrollIntoView(qs(steps[tourIndex].sel));
        placeFocus();
      }
    });
    nextBtn.addEventListener('click', async () => {
      if(tourIndex < steps.length - 1){
        tourIndex++;
        placeFocus();
        await stableScrollIntoView(qs(steps[tourIndex].sel));
        placeFocus();
      }else{
        endTour();
      }
    });
    document.addEventListener('keydown', function(e){
      if(!panelEl || panelEl.style.display === 'none') return;
      if(e.key === 'Escape'){
        endTour();
      }else if(e.key === 'ArrowRight'){
        nextBtn.click();
      }else if(e.key === 'ArrowLeft'){
        prevBtn.click();
      }
    });
    maskEl.addEventListener('click', () => { nextBtn.click(); });
    const v = vv();
    if(v){
      v.addEventListener('resize', placeFocus);
      v.addEventListener('scroll', placeFocus);
    }
    window.addEventListener('resize', placeFocus, { passive:true });
    window.addEventListener('scroll', placeFocus, { passive:true });
    window.addEventListener('orientationchange', () => setTimeout(placeFocus, 100));
  }

  function trackTutorial(eventName, params){
    try{
      if(typeof window.gtag === 'function'){
        window.gtag('event', eventName, params || {});
      }
    }catch(e){}
  }

  async function startTour(idx){
    if(typeof idx !== 'number') idx = 0;
    trackTutorial('tutorial_start',{ step: idx + 1 });
    ensureEls();
    tourIndex = idx;
    maskEl.style.display = 'block';
    focusEl.style.display = 'block';
    panelEl.style.display = 'block';
    document.body.style.overflow = 'hidden';
    placeFocus();
    const target = qs(steps[tourIndex].sel);
    if(target){ await stableScrollIntoView(target); }
    requestAnimationFrame(() => {
      requestAnimationFrame(placeFocus);
    });
    nextBtn.focus();
  }

  function endTour(){
    trackTutorial('tutorial_end',{ completed: tourIndex === steps.length - 1 });
    if(maskEl) maskEl.style.display = 'none';
    if(focusEl) focusEl.style.display = 'none';
    if(panelEl) panelEl.style.display = 'none';
    document.body.style.overflow = '';
    if(elevatedEl){
      elevatedEl.classList.remove('mk-tour-elevate');
      elevatedEl = null;
    }
    try{
      localStorage.setItem(TOUR_KEY,'1');
    }catch(e){}
  }

  const tourBtn = document.getElementById('startTour');
  if(tourBtn){ tourBtn.addEventListener('click', () => { startTour(0); }); }

  // ===== タブ切替 =====
  function updateTabMode(){
    const mode = document.querySelector('input[name="tabMode"]:checked')?.value || 'single';
    if(mode === 'single'){
      singleModeArea.classList.remove('hidden');
      multiModeArea.classList.add('hidden');
    }else{
      singleModeArea.classList.add('hidden');
      multiModeArea.classList.remove('hidden');
    }
  }

  tabModeRadios.forEach(r => r.addEventListener('change', updateTabMode));

  // ===== 単年タブ：モード切替 =====
  function updateMode(){
    const mode = document.querySelector('input[name="mode"]:checked')?.value || 'annual';
    if(mode === 'annual'){
      annualCard.classList.remove('hidden');
      seisanCard.classList.add('hidden');
      metricRate.classList.remove('hidden');
      metricSeisan.classList.add('hidden');
      resultSummary.textContent = '暦年課税（一般税率・特例税率）による贈与税額の概算結果です。';
      resultBaseSub.textContent = '暦年課税：年間の贈与額の合計 − 110万円（基礎控除）を控除した後の課税価格（千円未満切捨て）';
      resultRateSub.textContent = '国税庁 速算表（一般贈与財産用／特例贈与財産用）に基づき計算';
      resultTaxSub.textContent = '暦年課税：課税価格は千円未満切捨て／税額は100円未満切捨ての概算額です。';
    }else{
      annualCard.classList.add('hidden');
      seisanCard.classList.remove('hidden');
      metricRate.classList.add('hidden');
      metricSeisan.classList.remove('hidden');
      resultSummary.textContent = '相続時精算課税（年110万円の基礎控除＋特別控除2,500万円）による贈与税額の概算結果です。';
      resultBaseSub.textContent = '相続時精算課税：基礎控除110万円・特別控除適用後の課税価格（千円未満切捨て）';
      resultTaxSub.textContent = '相続時精算課税：課税価格は千円未満切捨て／税額は20％・100円未満切捨ての概算額です。';
    }
  }

  // 暦年課税：入力欄の切替
  function updateAnnualInputs(){
    const mode = document.querySelector('input[name="annualMode"]:checked')?.value || 'general';
    [annualGeneralOnly, annualSpecialOnly, annualBothGeneral, annualBothSpecial].forEach(el => el.classList.add('hidden'));
    if(mode === 'general'){
      annualGeneralOnly.classList.remove('hidden');
    }else if(mode === 'special'){
      annualSpecialOnly.classList.remove('hidden');
    }else{
      annualBothGeneral.classList.remove('hidden');
      annualBothSpecial.classList.remove('hidden');
    }
  }

  // ===== 単年：暦年課税計算 =====
  function handleCalcAnnual(){
    const mode = document.querySelector('input[name="annualMode"]:checked')?.value || 'general';
    let generalTotal = 0;
    let specialTotal = 0;
    let taxBase = 0;
    let taxAmount = 0;
    let summaryText = '';
    let rateText = '-';

    if(mode === 'general'){
      generalTotal = parseYenInput(annualGeneralAmount);
      const total = generalTotal;
      if(total <= 0){
        resetResult();
        resultSummary.textContent = '一般贈与財産の金額を入力してください。';
        return;
      }
      taxBase = Math.max(0, total - BASE_DEDUCTION);
      taxBase = truncateToThousand(taxBase);
      const general = calcTaxFromTable(taxBase, GENERAL_BRACKETS);
      taxAmount = roundTax100(general.tax);
      summaryText = '一般贈与財産のみ（暦年課税）として試算しています。';
      rateText = general.rate ? (Math.round(general.rate * 100) + '%／控除額 ' + formatYen(general.deduction) + '円') : '-';

    }else if(mode === 'special'){
      specialTotal = parseYenInput(annualSpecialAmount);
      const total = specialTotal;
      if(total <= 0){
        resetResult();
        resultSummary.textContent = '特例贈与財産の金額を入力してください。';
        return;
      }
      taxBase = Math.max(0, total - BASE_DEDUCTION);
      taxBase = truncateToThousand(taxBase);
      const special = calcTaxFromTable(taxBase, SPECIAL_BRACKETS);
      taxAmount = roundTax100(special.tax);
      summaryText = '特例贈与財産のみ（暦年課税）として試算しています。';
      rateText = special.rate ? (Math.round(special.rate * 100) + '%／控除額 ' + formatYen(special.deduction) + '円') : '-';

    }else{
      generalTotal = parseYenInput(annualGeneralAmountBoth);
      specialTotal = parseYenInput(annualSpecialAmountBoth);
      const total = generalTotal + specialTotal;
      if(total <= 0){
        resetResult();
        resultSummary.textContent = '一般贈与財産・特例贈与財産のいずれかに金額を入力してください。';
        return;
      }
      taxBase = Math.max(0, total - BASE_DEDUCTION);
      taxBase = truncateToThousand(taxBase);
      if(taxBase <= 0){
        taxAmount = 0;
        summaryText = '年間の贈与額の合計が基礎控除額（110万円）以下のため、贈与税はかかりません（暦年課税）。';
        rateText = '-';
      }else{
        const asGeneral = calcTaxFromTable(taxBase, GENERAL_BRACKETS);
        const asSpecial = calcTaxFromTable(taxBase, SPECIAL_BRACKETS);
        const totalTaxGeneral = asGeneral.tax;
        const totalTaxSpecial = asSpecial.tax;

        const shareGeneral = generalTotal / (generalTotal + specialTotal || 1);
        const shareSpecial = specialTotal / (generalTotal + specialTotal || 1);

        const taxGeneralPortion = totalTaxGeneral * shareGeneral;
        const taxSpecialPortion = totalTaxSpecial * shareSpecial;

        taxAmount = roundTax100(taxGeneralPortion + taxSpecialPortion);

        summaryText = '一般贈与財産と特例贈与財産の両方があるため、国税庁の計算例に基づき按分計算を行っています。';
        rateText = '一般税率・特例税率による按分計算（合計課税価格 ' + formatYen(taxBase) + '円ベース）';
      }
    }

    resultTax.textContent = formatYen(taxAmount) + ' 円';
    resultTaxSub.textContent = '暦年課税：課税価格は千円未満切捨て／税額は100円未満切捨ての概算額です。';
    resultBase.textContent = formatYen(taxBase) + ' 円';
    resultSummary.textContent = summaryText;
    resultRate.textContent = rateText;

    metricSeisan.classList.add('hidden');
    metricRate.classList.remove('hidden');
    resultSeisanSpecial.textContent = '- 円';
    resultSeisanUsedTotal.textContent = '- 円';
    resultSeisanSub.textContent = '累計特別控除利用額：- 円';
  }

  // ===== 単年：相続時精算課税計算 =====
  function handleCalcSeisan(){
    const amount = parseYenInput(seisanAmount);
    let usedBefore = parseYenInput(seisanUsedSpecial);

    if(amount <= 0){
      resetResult();
      resultSummary.textContent = '相続時精算課税の対象となる当年の贈与額を入力してください。';
      return;
    }

    if(usedBefore < 0) usedBefore = 0;
    if(usedBefore > SEISAN_SPECIAL_LIMIT) usedBefore = SEISAN_SPECIAL_LIMIT;

    const baseAfterKiso = Math.max(0, amount - BASE_DEDUCTION);
    const remainingSpecial = Math.max(0, SEISAN_SPECIAL_LIMIT - usedBefore);
    const specialThisYear = Math.min(baseAfterKiso, remainingSpecial);
    const taxableAfterSpecial = Math.max(0, baseAfterKiso - specialThisYear);

    const taxBase = truncateToThousand(taxableAfterSpecial);
    const rawTax = taxBase * 0.20;
    const tax = roundTax100(rawTax);
    const usedAfter = usedBefore + specialThisYear;

    resultTax.textContent = formatYen(tax) + ' 円';
    resultTaxSub.textContent = '相続時精算課税：課税価格は千円未満切捨て／税額は20％・100円未満切捨ての概算額です。';
    resultBase.textContent = formatYen(taxBase) + ' 円';
    resultBaseSub.textContent = '当年の贈与額 − 110万円 − 特別控除額等を控除した後の課税価格（千円未満切捨て）';
    resultSummary.textContent = '相続時精算課税（特定贈与者 1人分）として、基礎控除110万円と特別控除2,500万円の残額を考慮して試算しています。';

    metricRate.classList.add('hidden');
    metricSeisan.classList.remove('hidden');
    resultRate.textContent = '-';

    resultSeisanSpecial.textContent = formatYen(specialThisYear) + ' 円';
    resultSeisanUsedTotal.textContent = formatYen(usedAfter) + ' 円';
    resultSeisanSub.textContent = '累計特別控除利用額：' + formatYen(usedAfter) + ' 円（上限 25,000,000 円）';
  }

  // 単年結果リセット
  function resetResult(){
    resultTax.textContent = '- 円';
    resultTaxSub.textContent = '（課税価格は千円未満切捨て／税額は100円未満切捨て）';
    resultBase.textContent = '- 円';
    resultBaseSub.textContent = '基礎控除等控除後の課税価格（千円未満切捨て前）';
    resultRate.textContent = '-';
    resultSeisanSpecial.textContent = '- 円';
    resultSeisanUsedTotal.textContent = '- 円';
    resultSeisanSub.textContent = '累計特別控除利用額：- 円';
  }

  function clearAnnual(){
    [annualGeneralAmount, annualSpecialAmount, annualGeneralAmountBoth, annualSpecialAmountBoth].forEach(el => {
      if(el) el.value = '';
    });
    resetResult();
  }

  function clearSeisan(){
    if(seisanAmount) seisanAmount.value = '';
    if(seisanUsedSpecial) seisanUsedSpecial.value = '';
    resetResult();
  }

  // ===== 長期シミュレーション計算 =====
  function resetMultiResult(){
    multiResultSummary.textContent = '前提条件と各シナリオの設定をもとに、暦年贈与シナリオと相続時精算課税シナリオの税負担・残財産を概算しています。';
    multiAnnualTotalTax.textContent = '- 円';
    multiAnnualFinalEstate.textContent = '- 円';
    multiSeisanTotalTax.textContent = '- 円';
    multiSeisanFinalEstate.textContent = '- 円';
    multiTaxDiff.textContent = '- 円';
    multiTaxDiffSub.textContent = 'プラスなら相続時精算課税シナリオの方が税負担が軽い結果です。';
    multiResultCard.classList.add('hidden');
  }

  function clearMultiInputs(){
    if(multiEstateTotal) multiEstateTotal.value = '';
    if(multiYears) multiYears.value = '';
    if(multiReturnRate) multiReturnRate.value = '';
    if(multiEffRate) multiEffRate.value = '';
    if(multiAnnualGiftPerPerson) multiAnnualGiftPerPerson.value = '';
    if(multiAnnualRecipients) multiAnnualRecipients.value = '';
    if(multiSeisanInitialGift) multiSeisanInitialGift.value = '';
    if(multiSeisanAnnualGift) multiSeisanAnnualGift.value = '';
    if(multiSeisanUsedSpecialBefore) multiSeisanUsedSpecialBefore.value = '';
    resetMultiResult();
  }

  function handleMultiSim(){
    const estate0 = parseYenInput(multiEstateTotal);
    const yearsRaw = parseNumber(multiYears, 0);
    let years = Math.floor(yearsRaw);
    if(years <= 0){
      resetMultiResult();
      alert('相続までの想定年数を1年以上で入力してください。');
      return;
    }
    if(estate0 <= 0){
      resetMultiResult();
      alert('現在の相続財産総額を入力してください。');
      return;
    }

    let r = parseNumber(multiReturnRate, 0) / 100;
    if(!Number.isFinite(r) || r < -1) r = 0;
    let effRate = parseNumber(multiEffRate, 0) / 100;
    if(!Number.isFinite(effRate) || effRate < 0) effRate = 0;
    if(effRate > 1) effRate = 1;

    const giftPerPersonA = parseYenInput(multiAnnualGiftPerPerson);
    let recipientsA = parseNumber(multiAnnualRecipients, 0);
    recipientsA = Math.floor(recipientsA);
    if(recipientsA < 0) recipientsA = 0;

    const initialGiftB = parseYenInput(multiSeisanInitialGift);
    const annualGiftB = parseYenInput(multiSeisanAnnualGift);
    let usedSpecialBeforeB = parseYenInput(multiSeisanUsedSpecialBefore);
    if(usedSpecialBeforeB < 0) usedSpecialBeforeB = 0;
    if(usedSpecialBeforeB > SEISAN_SPECIAL_LIMIT) usedSpecialBeforeB = SEISAN_SPECIAL_LIMIT;

    // ---- 暦年贈与シナリオ ----
    let estateA = estate0;
    let totalGiftTaxA = 0;
    let addbackListA = [];

    for(let t=1; t<=years; t++){
      const plannedGiftTotal = giftPerPersonA * recipientsA;
      let giftTotal = plannedGiftTotal;
      if(estateA <= 0 || plannedGiftTotal <= 0){
        giftTotal = 0;
      }else if(plannedGiftTotal > estateA){
        giftTotal = estateA; // 残高を超える場合は残高まで
      }

      if(giftTotal > 0 && recipientsA > 0){
        const perGift = giftTotal / recipientsA;
        const basePer = Math.max(0, perGift - BASE_DEDUCTION);
        const taxBasePer = truncateToThousand(basePer);
        const taxInfoPer = calcTaxFromTable(taxBasePer, SPECIAL_BRACKETS); // 特例贈与前提
        const taxPer = roundTax100(taxInfoPer.tax);
        const taxYear = taxPer * recipientsA;
        totalGiftTaxA += taxYear;
      }

      // 【修正】暦年贈与の生前贈与加算は、基礎控除（110万）控除「前」の金額を加算する
      // （※経過措置の100万円控除等は考慮せず安全側に倒して全額加算）
      const addbackYear = giftTotal; 
      addbackListA.push(addbackYear);

      estateA = Math.max(0, estateA - giftTotal);
      estateA = estateA * (1 + r);
    }

    let addbackA = 0;
    const yearsForAddback = Math.min(years, 7);
    for(let i=0; i<yearsForAddback; i++){
      const idx = addbackListA.length - 1 - i;
      if(idx >= 0){ addbackA += addbackListA[idx]; }
    }

    const estateBaseA = estateA + addbackA;
    const estateTaxA = Math.max(0, estateBaseA * effRate);
    const totalTaxA = totalGiftTaxA + estateTaxA;

    // ---- 相続時精算課税シナリオ ----
    let estateB = estate0;
    let totalGiftTaxB = 0;
    let addbackB = 0;
    let remainingSpecialB = Math.max(0, SEISAN_SPECIAL_LIMIT - usedSpecialBeforeB);

    // 年1：一括贈与
    if(initialGiftB > 0 && estateB > 0){
      let gift1 = initialGiftB;
      if(gift1 > estateB) gift1 = estateB;

      const baseAfterKiso1 = Math.max(0, gift1 - BASE_DEDUCTION);
      const specialUse1 = Math.min(baseAfterKiso1, remainingSpecialB);
      remainingSpecialB -= specialUse1;
      const taxable1 = Math.max(0, baseAfterKiso1 - specialUse1);
      const taxBase1 = truncateToThousand(taxable1);
      const rawTax1 = taxBase1 * 0.20;
      const tax1 = roundTax100(rawTax1);
      totalGiftTaxB += tax1;

      const addback1 = Math.max(0, gift1 - BASE_DEDUCTION); // 基礎控除超部分が相続時に加算される前提
      addbackB += addback1;

      estateB = Math.max(0, estateB - gift1);
      estateB = estateB * (1 + r);
    }else{
      estateB = estateB * (1 + r);
    }

    // 年2〜N：毎年贈与
    for(let t=2; t<=years; t++){
      let giftYear = annualGiftB;
      if(estateB <= 0 || giftYear <= 0){
        giftYear = 0;
      }else if(giftYear > estateB){
        giftYear = estateB;
      }

      if(giftYear > 0){
        const baseAfterKiso = Math.max(0, giftYear - BASE_DEDUCTION);
        const specialUse = Math.min(baseAfterKiso, remainingSpecialB);
        remainingSpecialB -= specialUse;
        const taxable = Math.max(0, baseAfterKiso - specialUse);
        const taxBase = truncateToThousand(taxable);
        const rawTax = taxBase * 0.20;
        const tax = roundTax100(rawTax);
        totalGiftTaxB += tax;

        const addbackYearB = Math.max(0, giftYear - BASE_DEDUCTION);
        addbackB += addbackYearB;

        estateB = Math.max(0, estateB - giftYear);
      }
      estateB = estateB * (1 + r);
    }

    const estateBaseB = estateB + addbackB;
    const estateTaxB = Math.max(0, estateBaseB * effRate);

    let totalTaxB;
    let netEstateTaxB;
    if(estateTaxB >= totalGiftTaxB){
      netEstateTaxB = estateTaxB - totalGiftTaxB;
      totalTaxB = estateTaxB; // 贈与税は全額相続税から控除可能な範囲内
    }else{
      netEstateTaxB = 0;
      totalTaxB = totalGiftTaxB; // 贈与税の方が大きい場合
    }

    // 結果表示
    multiAnnualTotalTax.textContent = formatYen(Math.round(totalTaxA)) + ' 円';
    multiAnnualFinalEstate.textContent = formatYen(Math.round(estateA)) + ' 円';
    multiSeisanTotalTax.textContent = formatYen(Math.round(totalTaxB)) + ' 円';
    multiSeisanFinalEstate.textContent = formatYen(Math.round(estateB)) + ' 円';

    const diff = totalTaxA - totalTaxB;
    multiTaxDiff.textContent = formatYen(Math.round(diff)) + ' 円';
    if(diff > 0){
      multiTaxDiffSub.textContent = 'プラス（暦年 ＞ 精算）となっているため、この前提では相続時精算課税シナリオの方が税負担が軽い結果です。';
    }else if(diff < 0){
      multiTaxDiffSub.textContent = 'マイナス（暦年 ＜ 精算）となっているため、この前提では暦年贈与シナリオの方が税負担が軽い結果です。';
    }else{
      multiTaxDiffSub.textContent = '両シナリオの概算税負担は同程度となっています。その他の事情（将来の値上がり・ライフプラン等）も踏まえて検討が必要です。';
    }

    multiResultSummary.textContent = '入力いただいた前提条件のもとで、暦年贈与シナリオと相続時精算課税シナリオの税負担と相続時点の残財産を概算比較した結果です。';
    multiResultCard.classList.remove('hidden');
  }

  // 結果コピー
  function fallbackCopy(text){
    const ta = document.createElement('textarea');
    ta.value = text;
    ta.style.position = 'fixed';
    ta.style.left = '-9999px';
    document.body.appendChild(ta);
    ta.focus();
    ta.select();
    try{
      document.execCommand('copy');
      alert('試算結果をコピーしました。');
    }catch(e){
      alert('コピーに失敗しました。');
    }
    document.body.removeChild(ta);
  }

  function handleCopyResult(){
    const tabMode = document.querySelector('input[name="tabMode"]:checked')?.value || 'single';

    if(tabMode === 'single'){
      const mode = document.querySelector('input[name="mode"]:checked')?.value || 'annual';
      const lines = [];
      const summary = (resultSummary.textContent || '').trim();

      lines.push('【贈与税試算結果（単年）】');
      if(summary) lines.push(summary);
      lines.push('');
      lines.push('概算贈与税額：' + (resultTax.textContent || '').trim());
      lines.push('基礎控除後の課税価格：' + (resultBase.textContent || '').trim());

      if(mode === 'annual'){
        lines.push('適用税率・控除額：' + (resultRate.textContent || '').trim());
      }else{
        lines.push('当年特別控除利用額：' + (resultSeisanSpecial.textContent || '').trim());
        lines.push((resultSeisanSub.textContent || '').trim());
      }
      lines.push('');
      lines.push('※本ツールは税額の「概算」を把握するためのものであり、実際の贈与の実行・申告にあたっては専門家にご相談ください。');

      const text = lines.join('\n');
      if(navigator.clipboard && navigator.clipboard.writeText){
        navigator.clipboard.writeText(text)
          .then(() => { alert('試算結果をコピーしました。'); })
          .catch(() => { fallbackCopy(text); });
      }else{
        fallbackCopy(text);
      }
    }else{
      const lines = [];
      lines.push('【贈与税・相続税試算結果（長期シミュレーション）】');
      lines.push((multiResultSummary.textContent || '').trim());
      lines.push('');
      lines.push('［暦年贈与シナリオ］');
      lines.push('トータル税負担：' + (multiAnnualTotalTax.textContent || '').trim());
      lines.push('相続時点の残財産：' + (multiAnnualFinalEstate.textContent || '').trim());
      lines.push('');
      lines.push('［相続時精算課税シナリオ］');
      lines.push('トータル税負担：' + (multiSeisanTotalTax.textContent || '').trim());
      lines.push('相続時点の残財産：' + (multiSeisanFinalEstate.textContent || '').trim());
      lines.push('');
      lines.push('税負担の差額（暦年 − 精算）：' + (multiTaxDiff.textContent || '').trim());
      lines.push((multiTaxDiffSub.textContent || '').trim());
      lines.push('');
      lines.push('※長期シミュレーションは、相続税を「想定相続税実効税率」による概算で計算しており、実際の相続税額とは異なる場合があります。');

      const text = lines.join('\n');
      if(navigator.clipboard && navigator.clipboard.writeText){
        navigator.clipboard.writeText(text)
          .then(() => { alert('試算結果をコピーしました。'); })
          .catch(() => { fallbackCopy(text); });
      }else{
        fallbackCopy(text);
      }
    }
  }

  // 全体リセット
  function handleResetAll(){
    const tabSingle = document.querySelector('input[name="tabMode"][value="single"]');
    if(tabSingle){ tabSingle.checked = true; }
    updateTabMode();

    const modeAnnual = document.querySelector('input[name="mode"][value="annual"]');
    if(modeAnnual){ modeAnnual.checked = true; }
    const annualModeGeneral = document.querySelector('input[name="annualMode"][value="general"]');
    if(annualModeGeneral){ annualModeGeneral.checked = true; }

    updateMode();
    updateAnnualInputs();
    clearAnnual();
    clearSeisan();
    resetResult();
    clearMultiInputs();
    window.scrollTo({ top:0, behavior:'smooth' });
  }

  // 印刷
  function handlePrint(){ window.print(); }

  // イベント設定
  modeRadios.forEach(r => r.addEventListener('change', updateMode));
  annualModeRadios.forEach(r => r.addEventListener('change', updateAnnualInputs));
  if(calcAnnualBtn) calcAnnualBtn.addEventListener('click', handleCalcAnnual);
  if(calcSeisanBtn) calcSeisanBtn.addEventListener('click', handleCalcSeisan);
  if(annualClear) annualClear.addEventListener('click', clearAnnual);
  if(seisanClear) seisanClear.addEventListener('click', clearSeisan);

  if(runMultiSimBtn) runMultiSimBtn.addEventListener('click', handleMultiSim);
  if(multiClearBtn) multiClearBtn.addEventListener('click', clearMultiInputs);

  if(copyResultBtn) copyResultBtn.addEventListener('click', handleCopyResult);
  if(resetAllBtn) resetAllBtn.addEventListener('click', handleResetAll);
  if(printBtn) printBtn.addEventListener('click', handlePrint);

  // 初期表示
  updateTabMode();
  updateMode();
  updateAnnualInputs();
  resetResult();
  resetMultiResult();
})();
</script>

</body>
</html>
