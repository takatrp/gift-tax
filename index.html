<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>贈与税試算ツール</title>

  <!-- ファビコン設定 (必要に応じて画像を用意してください) -->
  <link rel="icon" type="image/png" sizes="192x192" href="./favicon192192.png" />
  <link rel="apple-touch-icon" href="./favicon192192.png" />
  <meta name="theme-color" content="#578899" />

  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <style>
    :root{
      --bg:#f4f9fb;
      --card:#ffffff;
      --ink:#1e2a2d;
      --muted:#5a6a6d;
      --accent:#578899;
      --accent-dark:#476a7c;
      --accent-soft:rgba(87,136,153,.08);
      --border:#d4e1e7;
      --danger:#b42318;
      /* 数値強調用の緑色 */
      --success-text: #009e7f; 
      --shadow:0 18px 40px rgba(20,50,70,.12);
      --radius-lg:18px;
      --radius-pill:999px;
      
      --btn-soft-bg: #f0f8fa;
      --btn-soft-border: #dbe9ee;
      --btn-soft-text: #4a7d8f;
      --btn-outline-border: #4a7d8f;
    }
    
    /* 基本リセット */
    *{box-sizing:border-box;}
    html,body{height:100%;}
    body{
      margin:0;
      font-size: 15px;
      font-family:-apple-system,BlinkMacSystemFont,"Hiragino Kaku Gothic ProN","Yu Gothic","Noto Sans JP",Segoe UI,Roboto,Arial,sans-serif;
      background:var(--bg);
      color:var(--ink);
      line-height: 1.6;
      -webkit-text-size-adjust: 100%;
    }

    /* 印刷専用要素（画面では非表示） */
    .print-header-fixed, .print-footer-fixed {
      display: none;
    }

    /* アプリケーション構造 */
    .app{
      min-height:100vh;
      display:flex;
      flex-direction:column;
    }
    
    /* 画面用ヘッダー */
    .app-header{
      background:rgba(244, 249, 251, 0.95);
      padding: 12px 0 8px;
      border-bottom:1px solid #d4e1e7;
      position: sticky;
      top: 0;
      z-index: 100;
      backdrop-filter: blur(8px);
    }
    .header-bar{
      max-width:1080px;
      margin:0 auto;
      display:flex;
      align-items:center;
      justify-content: space-between;
      padding: 0 16px;
    }
    .brand{
      display:inline-flex;
      align-items:center;
      gap:12px;
      text-decoration:none;
      color:var(--ink);
    }
    .brand-logo{
      height:44px;
      width:auto;
      border-radius:12px;
    }
    .brand-text{
      display:flex;
      flex-direction:column;
      gap:2px;
    }
    .brand-title{
      font-size:22px;
      margin:0;
      font-weight:700;
    }
    .brand-subtitle{
      margin:0;
      font-size:12px;
      color:var(--muted);
    }

    /* メインレイアウト */
    .layout{
      width:100%;
      max-width:1080px;
      margin:0 auto;
      padding:16px;
      flex:1 0 auto;
    }

    /* カードコンポーネント */
    .card{
      background:var(--card);
      border-radius:var(--radius-lg);
      box-shadow:var(--shadow);
      padding:24px;
      margin-bottom:20px;
      border:1px solid rgba(255,255,255,.8);
    }
    .card-header{
      display:flex;
      justify-content:space-between;
      align-items:flex-start;
      gap:8px;
      margin-bottom:16px;
      flex-wrap: wrap;
    }
    .card-title{
      margin:0;
      font-size:18px;
      font-weight:700;
      display:flex;
      align-items:center;
      gap:10px;
    }
    .badge{
      display:inline-flex;
      align-items:center;
      padding:4px 10px;
      border-radius:var(--radius-pill);
      border:1px solid rgba(255,255,255,.8);
      font-size:11px;
      background:rgba(0,0,0,.05);
      color: var(--muted);
    }

    /* フォーム要素 */
    .grid{ display:grid; gap:16px 20px; }
    .grid-2{ grid-template-columns:repeat(2,minmax(0,1fr)); }
    .grid-3{ grid-template-columns:repeat(3,minmax(0,1fr)); }
    @media(max-width:768px){
      .grid-2, .grid-3{ grid-template-columns:1fr; }
    }

    .field{ display:flex; flex-direction:column; gap:6px; }
    .field label{ font-size:14px; font-weight:700; color:var(--ink); }
    .field small{ font-size:12px; color:var(--muted); line-height: 1.5; }

    input[type="number"], input[type="text"], select{
      border-radius:10px;
      border:1px solid var(--border);
      padding:12px;
      font-size:16px;
      width:100%;
      background:#f9fcff;
      text-align: right;
      outline:none;
    }
    input:focus{
      border-color:var(--accent);
      background:#fff;
      box-shadow:0 0 0 3px var(--accent-soft);
    }
    input.align-left{ text-align:left; }
    
    /* チェックボックスUI */
    .checkbox-chip {
      display:inline-flex;
      align-items:center;
      gap:8px;
      font-weight:700;
      color:var(--ink);
      cursor:pointer;
      padding:8px 0;
    }
    .checkbox-chip input {
      transform: scale(1.3);
      cursor: pointer;
    }

    /* ラジオボタン風UI */
    .radio-row{ display:flex; flex-wrap:wrap; gap:10px; }
    .radio-chip{
      display:inline-flex;
      align-items:center;
      gap:6px;
      padding:10px 16px;
      border-radius:var(--radius-pill);
      cursor:pointer;
      font-weight:700;
      font-size:14px;
      border:1px solid transparent;
      transition:all .2s;
    }
    .radio-chip input{ display:none; }
    .radio-chip span::before{
      content:""; width:16px; height:16px;
      border-radius:50%; border:2px solid #ccc;
      display:inline-block; margin-right:6px; vertical-align:-3px;
    }
    .radio-chip input:checked + span{ color:var(--accent); }
    .radio-chip input:checked + span::before{
      border-color:var(--accent);
      background:radial-gradient(circle, var(--accent) 40%, #fff 45%);
    }

    /* ボタン */
    .btn-row{ display:flex; gap:12px; margin-top:20px; flex-wrap:wrap; }
    .btn-calc{
      border:none; border-radius:var(--radius-pill);
      padding:12px 28px; font-weight:700;
      background:var(--accent); color:#fff;
      cursor:pointer; display:flex; align-items:center; gap:8px;
      box-shadow:0 4px 12px rgba(87,136,153,.3);
    }
    .btn-ghost{
      background:transparent; border:1px dashed var(--border);
      color:var(--muted); padding:10px 20px; border-radius:var(--radius-pill);
      cursor:pointer; font-size:13px;
    }
    
    /* 結果表示エリア */
    .result-card{ border-left:4px solid var(--accent); background:#fff; }
    .result-grid{ display:grid; gap:12px; grid-template-columns:repeat(auto-fit, minmax(240px, 1fr)); }
    .metric{
      padding:16px; border-radius:12px; background:var(--accent-soft);
      border:1px solid rgba(87,136,153,.1);
    }
    .metric-featured{ background:#fff; border:2px solid var(--accent); box-shadow:0 4px 12px rgba(87,136,153,.15); }
    .metric-label{ font-size:12px; color:var(--muted); margin-bottom:4px; }
    .metric-value{ font-size:22px; font-weight:700; color:var(--ink); }
    .metric-sub{ font-size:11px; color:var(--muted); margin-top:4px; }

    /* 概算贈与税額、差額等の重要数値を緑色にするクラス */
    #resultTax, #multiAnnualTotalTax, #multiSeisanTotalTax, #multiTaxDiff, #multiNetDiff {
      color: var(--success-text);
      font-weight: 800;
    }

    /* グラフ・表 */
    .chart-container{ position:relative; height:300px; width:100%; margin-top:20px; }
    .detail-table{
      width:100%; border-collapse:collapse; font-size:13px; margin-top:16px;
      white-space:nowrap;
    }
    .detail-table th, .detail-table td{
      border:1px solid var(--border); padding:8px; text-align:right;
    }
    .detail-table th{ background:#f7fafb; text-align:center; }
    
    /* 計算詳細エリア */
    .calc-detail-box {
      margin-top: 20px;
      background: #fdfdfd;
      border: 1px solid var(--border);
      border-radius: 8px;
      padding: 16px;
    }
    .calc-detail-title {
      font-size: 14px;
      font-weight: 700;
      color: var(--accent-dark);
      margin-bottom: 10px;
      border-bottom: 1px dashed var(--border);
      padding-bottom: 6px;
    }
    .calc-row {
      display: flex;
      justify-content: space-between;
      margin-bottom: 6px;
      font-size: 13px;
    }
    .calc-row.sum-row {
      border-top: 1px solid #eee;
      padding-top: 6px;
      margin-top: 6px;
      font-weight: bold;
      color: var(--ink);
    }
    .calc-row.deduction-row {
      color: var(--danger);
    }
    .calc-note {
      font-size: 11px;
      color: var(--muted);
      margin-top: 4px;
    }

    /* 下部アクション */
    .action-buttons{ display:flex; gap:12px; flex-wrap:wrap; margin-top:0; }
    .btn-soft, .btn-outline{
      flex:1; padding:12px; border-radius:8px; font-weight:700; cursor:pointer; text-align:center;
    }
    .btn-soft{ background:var(--btn-soft-bg); color:var(--btn-soft-text); border:1px solid var(--btn-soft-border); }
    .btn-outline{ background:#fff; color:var(--btn-outline-border); border:2px solid var(--btn-outline-border); }

    .hidden{ display:none!important; }
    
    /* チュートリアル・フッターなど */
    .btn-tutorial{
      font-size:12px; padding:6px 12px; border-radius:8px; border:1px solid var(--border);
      background:#fff; color:var(--accent); cursor:pointer;
    }
    .note-card li{ font-size:13px; color:var(--muted); margin-bottom:6px; }
    .note-highlight{
      border-radius:10px;
      padding:12px;
      background:#fffbe8;
      border:1px solid #f5e2a0;
      font-size:13px;
      color:#6a4c0a;
      margin-top:12px;
      line-height: 1.6;
    }

    footer.mk-mini {
      text-align: center;
      font-size: 12px;
      color: var(--muted);
      padding: 20px;
    }
    footer.mk-mini a{ color:inherit; }

    /* チュートリアルポップアップ */
    .mk-tour-mask { position: fixed; inset: 0; background: transparent; z-index: 9998; }
    .mk-tour-focus { position: fixed; border-radius: 12px; box-shadow: 0 0 0 9999px rgba(15, 23, 42, 0.5), 0 0 0 4px #fff, 0 0 0 8px rgba(87, 136, 153, 0.6); z-index: 10001; pointer-events: none; }
    .mk-tour-panel { position: fixed; z-index: 10002; max-width: min(560px, 92vw); background: #fff; border: 1px solid var(--border); border-radius: 16px; box-shadow: 0 14px 36px rgba(0,0,0,.25); padding: 16px; }
    .mk-tour-head{display:flex;align-items:center;gap:8px;margin-bottom:8px}
    .mk-tour-step{font-size:12px;color:#475569}
    .mk-tour-title{font-weight:800;font-size:15px}
    .mk-tour-body{font-size:14px;color:var(--ink);line-height:1.5}
    .mk-tour-actions{display:flex;justify-content:flex-end;gap:8px;margin-top:12px}
    .mk-tour-actions .tbtn{border-radius:10px;border:1px solid var(--border);background:#fff;padding:8px 14px;font-weight:700;cursor:pointer;font-size:13px}
    .mk-tour-actions .tbtn.primary{background:var(--accent);border-color:var(--accent);color:#fff}


    /* =========================================
       印刷設定 (Print CSS) - 全ページ固定ヘッダー/フッター版
       ========================================= */
    @media print {
      @page {
        size: A4;
        /* ヘッダー・フッター用のスペースをここで確保します */
        margin-top: 25mm; 
        margin-bottom: 25mm; /* フッター用マージンを拡大 */
        margin-left: 15mm;
        margin-right: 15mm;
      }

      body {
        background: #fff !important;
        color: #000 !important;
        font-size: 10.5pt;
        -webkit-print-color-adjust: exact;
        print-color-adjust: exact;
        /* コンテンツがフッターに被らないよう念のためpaddingも追加 */
        padding-bottom: 20mm;
      }

      .app {
        display: block !important;
        height: auto !important;
        overflow: visible !important;
        padding-top: 0;
      }

      .app-header, .btn-row, .btn-tutorial, .btn-ghost, 
      .action-buttons, .pill-switch, 
      #startTour, #toggleDetailsBtn, #loadSampleBtn, 
      .mk-tour-mask, .mk-tour-focus, .mk-tour-panel,
      footer.mk-mini {
        display: none !important;
      }

      /* 固定ヘッダー */
      .print-header-fixed {
        display: flex !important;
        position: fixed;
        top: -15mm; 
        left: 0;
        width: 100%;
        height: 15mm;
        justify-content: space-between;
        align-items: flex-end;
        border-bottom: 2px solid var(--accent);
        padding-bottom: 5px;
        background-color: #fff;
        z-index: 9999;
      }

      /* 固定フッター（画像表示用） */
      .print-footer-fixed {
        display: flex !important;
        position: fixed;
        /* 全ページの下部に固定配置 */
        bottom: 0; 
        left: 0;
        width: 100%;
        height: 20mm; /* エリアの高さを確保 */
        align-items: flex-end; /* 下揃え */
        justify-content: center; /* 中央配置 */
        /* 背景を白にして、本文が重なった場合に文字が透けないようにする */
        background-color: #fff; 
        z-index: 9999;
        padding-bottom: 5mm; /* 用紙の端から少し浮かせる */
      }
      
      .print-footer-img {
        max-height: 15mm; /* 画像サイズ制限 */
        max-width: 100%;
        object-fit: contain;
      }

      .print-logo-section { display: flex; align-items: center; gap: 15px; }
      /* 画像がない場合のフォールバック */
      .print-logo { height: 35px; width: auto; object-fit: contain; }
      .print-company-name { font-size: 14pt; font-weight: 700; color: var(--ink); }
      .print-report-title { font-size: 10pt; color: var(--muted); }

      .layout {
        display: block !important;
        width: 100%;
        margin: 0;
        padding: 0;
      }

      .card {
        box-shadow: none;
        border: none;
        border-bottom: 1px solid #eee;
        padding: 5px 0;
        margin-bottom: 15px;
        break-inside: avoid;
        page-break-inside: avoid;
        background: transparent;
      }
      .card-header {
        margin-bottom: 5px;
        border-bottom: none;
      }
      .card-title {
        font-size: 12pt;
        color: #000;
        border-left: 4px solid var(--accent);
        padding-left: 10px;
      }
      
      .field {
        flex-direction: row;
        align-items: center;
        justify-content: space-between;
        border-bottom: 1px dotted #ccc;
        padding: 4px 0;
        page-break-inside: avoid;
      }
      .field label {
        color: #444;
        font-weight: normal;
        font-size: 10pt;
      }
      .field small { display: none !important; }
      
      input[type="number"], input[type="text"], select {
        border: none;
        background: transparent;
        text-align: right;
        font-weight: bold;
        color: #000;
        width: auto;
        padding: 0;
        font-size: 11pt;
        -webkit-appearance: none;
        appearance: none;
      }
      input::placeholder { color: transparent; }
      .badge { display: none !important; }

      .radio-row {
        gap: 15px;
        justify-content: flex-end;
      }
      .radio-chip {
        padding: 0;
        border: none;
      }
      .radio-chip input:not(:checked) + span { display: none; }
      .radio-chip input:checked + span {
        color: #000;
        font-weight: bold;
        font-size: 11pt;
      }
      .radio-chip span::before { display: none; }
      .checkbox-chip { padding:0; }

      .result-card {
        background: #fdfdfd !important;
        border: 2px solid var(--accent) !important;
        border-radius: 8px;
        padding: 15px;
        margin-top: 20px;
        break-inside: avoid;
      }
      .metric {
        background: transparent;
        border: none;
        padding: 5px 0;
        border-bottom: 1px solid #eee;
      }
      .metric-featured {
        background: #f0f8fa !important;
        border: 1px solid var(--accent);
        padding: 15px;
      }

      /* 印刷時も緑色を強制する */
      #resultTax, #multiAnnualTotalTax, #multiSeisanTotalTax, #multiTaxDiff, #multiNetDiff {
        color: var(--success-text) !important;
        -webkit-print-color-adjust: exact;
        print-color-adjust: exact;
      }

      .chart-container {
        height: 250px !important;
        width: 80% !important;
        margin: 20px auto !important;
        page-break-inside: avoid;
      }
      canvas { width: 100% !important; height: 100% !important; }

      #detailsArea {
        display: block !important;
        break-before: page;
        margin-top: 20px !important;
      }
      .detail-table th {
        background: #eee !important;
        color: #000;
        border: 1px solid #000;
      }
      .detail-table td {
        border: 1px solid #000;
        color: #000;
      }
      /* テーブルヘッダーを各ページに表示 */
      thead { display: table-header-group; }
      
      /* 詳細エリアの印刷用 */
      .calc-detail-box {
        page-break-inside: avoid;
        border: 1px solid #000;
      }

      /* 最終ページのご利用上の注意をカラー印刷する */
      .note-card {
        display: block !important;
        border: 1px solid #eee;
        background: #f9f9f9 !important;
        page-break-inside: avoid;
        -webkit-print-color-adjust: exact;
        print-color-adjust: exact;
      }
      .note-card .card-title { font-size: 10pt; border: none; padding: 0; }
      
      .note-highlight {
        border: 1px solid #f5e2a0 !important;
        background-color: #fffbe8 !important;
        color: #6a4c0a !important;
        padding: 5px 10px;
        font-size: 9pt;
        font-weight: bold;
        -webkit-print-color-adjust: exact;
        print-color-adjust: exact;
      }

      .grid, .grid-2, .grid-3 { display: block !important; }
      .grid > div, .grid-2 > div { margin-bottom: 5px; page-break-inside: avoid; }
      
      .print-break-before {
        break-before: page;
        page-break-before: always;
        margin-top: 30px !important;
        display: block !important;
      }
    }
  </style>
</head>
<body>

<!-- 印刷用 固定ヘッダー (全ページに強制表示) -->
<div class="print-header-fixed">
  <div class="print-logo-section">
    <!-- ロゴ画像がない場合はaltテキストが表示されます。画像ファイル(logo.jpg)を同じフォルダに置いてください -->
    <img src="./logo.jpg" alt="Logo" class="print-logo" onerror="this.style.display='none';">
    <span class="print-company-name">税理士法人松本会計事務所</span>
  </div>
  <div class="print-report-title">贈与税試算シミュレーションレポート</div>
</div>

<!-- 印刷用 固定フッター (全ページに強制表示、画像 footer.png を使用) -->
<div class="print-footer-fixed">
  <!-- footer.png が見つからない場合はテキストを表示するフォールバックを追加 -->
  <img src="./footer.png" alt="Copyright (c) Matsumoto Accounting Office." class="print-footer-img" onerror="this.style.display='none'; this.nextElementSibling.style.display='block';">
  <span style="display:none; font-size:9pt; color:#888;">© 税理士法人松本会計事務所</span>
</div>

<div class="app">
  
  <!-- 画面表示用ヘッダー -->
  <header class="app-header">
    <div class="header-bar">
      <a href="https://takatrp.github.io/tool-portal/" class="brand">
        <!-- ロゴ画像がない場合は非表示 -->
        <img src="./logo.jpg" alt="税理士法人松本会計事務所" class="brand-logo" onerror="this.style.display='none';">
        <div class="brand-text">
          <h1 class="brand-title">贈与税試算ツール</h1>
          <p class="brand-subtitle">暦年課税（一般・特例）／相続時精算課税／長期シミュレーション</p>
        </div>
      </a>
      <button type="button" class="btn-tutorial" id="startTour">チュートリアル</button>
    </div>
  </header>

  <!-- メインコンテンツ -->
  <main class="layout">

    <!-- モードタブ切替 -->
    <section class="card">
      <div class="card-header">
        <h2 class="card-title">モード選択</h2>
        <div class="badge">令和7年4月1日現在法令等ベース</div>
      </div>
      <div class="card-body">
        <div class="radio-row" id="tabSwitch">
          <label class="radio-chip">
            <input type="radio" name="tabMode" value="single" checked>
            <span>単年試算（1年分の贈与税）</span>
          </label>
          <label class="radio-chip">
            <input type="radio" name="tabMode" value="multi">
            <span>長期シミュレーション（暦年 vs 精算）</span>
          </label>
        </div>
        <div style="margin-top:12px; font-size:13px; color:var(--muted); line-height:1.5;">
          単年試算タブでは「1人の受贈者について1年間の贈与税額」を、長期シミュレーションタブでは
          「相続財産・相続までの年数・毎年の贈与額等」を前提とした暦年課税 vs 相続時精算課税の概算比較を行います。
        </div>
      </div>
    </section>

    <!-- 単年試算エリア -->
    <div id="singleModeArea">
      <section class="card">
        <div class="card-header">
          <h2 class="card-title">STEP1 計算方法の選択</h2>
        </div>
        <div class="card-body">
          <div class="field">
            <label>試算したい贈与税の計算方法</label>
            <div class="radio-row" id="modeSwitch">
              <label class="radio-chip">
                <input type="radio" name="mode" value="annual" checked>
                <span>暦年課税（一般・特例）</span>
              </label>
              <label class="radio-chip">
                <input type="radio" name="mode" value="seisan">
                <span>相続時精算課税</span>
              </label>
            </div>
            <small>※ 本タブは 1人の受贈者について、1年間の贈与額を前提としています（申告書作成時は国税庁様式でご確認ください）。</small>
          </div>
        </div>
      </section>

      <section class="card" id="annualCard">
        <div class="card-header">
          <h2 class="card-title">STEP2-Ａ 暦年課税の入力</h2>
        </div>
        <div class="card-body">
          <div class="field">
            <label>贈与の区分</label>
            <div class="radio-row">
              <label class="radio-chip">
                <input type="radio" name="annualMode" value="general" checked />
                <span>一般贈与財産のみ</span>
              </label>
              <label class="radio-chip">
                <input type="radio" name="annualMode" value="special" />
                <span>特例贈与財産のみ（直系尊属→18歳以上の子・孫など）</span>
              </label>
              <label class="radio-chip">
                <input type="radio" name="annualMode" value="both" />
                <span>一般＋特例の両方あり</span>
              </label>
            </div>
            <small>※ 特例贈与財産に該当するかどうかは、受贈者の年齢（1月1日時点18歳以上）と贈与者との関係（直系尊属かどうか）で判定されます。</small>
          </div>

          <div class="grid grid-2" style="margin-top:10px;" id="annualInputs">
            <div class="field annual-group annual-general-only" id="annualGeneralOnly">
              <label>一般贈与財産の年間贈与額</label>
              <input type="text" inputmode="numeric" id="annualGeneralAmount" placeholder="例）3,000,000" class="yen-input" />
              <small>兄弟姉妹・配偶者などからの贈与、または18歳未満の子・孫への贈与など。</small>
            </div>
            <div class="field annual-group annual-special-only hidden" id="annualSpecialOnly">
              <label>特例贈与財産の年間贈与額</label>
              <input type="text" inputmode="numeric" id="annualSpecialAmount" placeholder="例）4,000,000" class="yen-input" />
              <small>18歳以上の子・孫などが、父母・祖父母から受ける贈与（住宅取得資金等の特例は含みません）。</small>
            </div>
            <div class="field annual-group annual-both hidden" id="annualBothGeneral">
              <label>一般贈与財産の年間贈与額（一般＋特例）</label>
              <input type="text" inputmode="numeric" id="annualGeneralAmountBoth" placeholder="例）1,000,000" class="yen-input" />
              <small>配偶者・兄弟姉妹などからの贈与分。</small>
            </div>
            <div class="field annual-group annual-both hidden" id="annualBothSpecial">
              <label>特例贈与財産の年間贈与額（一般＋特例）</label>
              <input type="text" inputmode="numeric" id="annualSpecialAmountBoth" placeholder="例）4,000,000" class="yen-input" />
              <small>直系尊属からの贈与分。</small>
            </div>
          </div>

          <div class="btn-row">
            <button type="button" class="btn-calc" id="calcAnnualBtn">
              <span class="btn-calc-icon">▶</span>
              <span>暦年課税で試算する</span>
            </button>
            <button type="button" class="btn-ghost" id="annualClear">入力をクリア</button>
          </div>
        </div>
      </section>

      <section class="card hidden" id="seisanCard">
        <div class="card-header">
          <h2 class="card-title">STEP2-Ｂ 相続時精算課税の入力</h2>
        </div>
        <div class="card-body">
          <div class="grid grid-2">
            <div class="field">
              <label>今年 1年間の贈与額（特定贈与者 1人分）</label>
              <input type="text" inputmode="numeric" id="seisanAmount" placeholder="例）5,000,000" class="yen-input" />
              <small>※父・母など、精算課税を選択した「特定の贈与者1名」からの贈与額を入力してください。複数人から受けている場合は個別に計算が必要です。</small>
            </div>
            <div class="field">
              <label>前年までに使用済みの特別控除額</label>
              <input type="text" inputmode="numeric" id="seisanUsedSpecial" placeholder="例）12,000,000" class="yen-input" />
              <small>2,500万円の特別控除のうち、既に控除に使った累計額（0〜25,000,000）。</small>
            </div>
          </div>
          <div class="btn-row">
            <button type="button" class="btn-calc" id="calcSeisanBtn">
              <span class="btn-calc-icon">▶</span>
              <span>相続時精算課税で試算する</span>
            </button>
            <button type="button" class="btn-ghost" id="seisanClear">入力をクリア</button>
          </div>
        </div>
      </section>

      <section class="card result-card" id="resultCard">
        <div class="card-header">
          <h2 class="card-title">STEP3 試算結果</h2>
        </div>
        <div class="card-body">
          <p id="resultSummary" class="result-heading">入力内容をもとに、贈与税額を概算しています。</p>
          <div class="result-grid">
            <div class="metric metric-featured">
              <div class="metric-label">概算贈与税額</div>
              <div class="metric-value" id="resultTax">- 円</div>
              <div class="metric-sub" id="resultTaxSub">（100円未満切捨て）</div>
            </div>
            <div class="metric">
              <div class="metric-label">基礎控除後の課税価格</div>
              <div class="metric-value" id="resultBase">- 円</div>
              <div class="metric-sub" id="resultBaseSub">贈与総額 − 110万円</div>
            </div>
            <div class="metric" id="metricRate">
              <div class="metric-label">適用税率・控除額（暦年課税）</div>
              <div class="metric-value" id="resultRate">-</div>
              <div class="metric-sub" id="resultRateSub">一般／特例ごとの速算表に基づき計算</div>
            </div>
            <div class="metric" id="metricSeisan">
              <div class="metric-label">相続時精算課税：当年の特別控除利用額</div>
              <div class="metric-value" id="resultSeisanSpecial">- 円</div>
              <div class="metric-sub" id="resultSeisanSub">累計特別控除利用額：<span id="resultSeisanUsedTotal">- 円</span></div>
            </div>
          </div>
        </div>
      </section>
    </div>

    <!-- 長期シミュレーションエリア -->
    <div id="multiModeArea" class="hidden">
      <section class="card" id="multiCommonCard">
        <div class="card-header">
          <h2 class="card-title">STEP1 長期シミュレーションの前提条件</h2>
          <button type="button" class="btn-tutorial" id="loadSampleBtn" style="font-size:12px; padding:4px 10px;">サンプル読込</button>
        </div>
        <div class="card-body">
          <div class="grid grid-3">
            <div class="field">
              <label>現在の相続財産総額（贈与前）</label>
              <input type="text" inputmode="numeric" id="multiEstateTotal" placeholder="例）150,000,000" class="yen-input" />
              <small>預金・有価証券・不動産など。</small>
            </div>
            <div class="field">
              <label>相続までの想定年数</label>
              <input type="number" id="multiYears" class="align-left" placeholder="例）15" min="1" step="1" />
              <small>相続が発生するまでの期間。</small>
            </div>
            <div class="field">
              <label>年間運用利回り（％）</label>
              <input type="number" id="multiReturnRate" class="align-left" placeholder="例）1.0" step="0.1" />
              <small>相続財産全体の平均的な増減率。</small>
            </div>
          </div>
          <div class="grid grid-2" style="margin-top:12px;">
            <div class="field">
              <label>受贈者の人数</label>
              <input type="number" id="multiRecipients" class="align-left" placeholder="例）2" min="1" step="1" />
              <small>贈与を受ける子・孫の人数。</small>
            </div>
            <div class="field">
              <label>法定相続人の数（配偶者含む）</label>
              <input type="number" id="multiHeirs" class="align-left" placeholder="例）3" min="1" step="1" />
              <small>相続税の基礎控除計算等に使用する法定相続人の数。</small>
              <label class="checkbox-chip">
                <input type="checkbox" id="multiSpouse">
                <span>配偶者あり</span>
              </label>
            </div>
          </div>
        </div>
      </section>

      <!-- STEP1と同じページに表示 -->
      <section class="card" id="multiAnnualCard">
        <div class="card-header">
          <h2 class="card-title">STEP2-A 暦年贈与シナリオ（毎年コツコツ型）</h2>
        </div>
        <div class="card-body">
          <div class="grid grid-2">
            <div class="field">
              <label>1人あたり毎年の贈与額</label>
              <input type="text" inputmode="numeric" id="multiAnnualGiftPerPerson" placeholder="例）3,000,000" class="yen-input" />
              <small>特例贈与財産（直系尊属→18歳以上の子・孫）を前提とします。</small>
            </div>
          </div>
          <small>
            ※ STEP1で設定した「受贈者の人数」全員に、毎年同額を贈与する前提で計算します。
          </small>
        </div>
      </section>

      <section class="card" id="multiSeisanCard">
        <div class="card-header">
          <h2 class="card-title">STEP2-B 相続時精算課税シナリオ（まとめて移転型）</h2>
        </div>
        <div class="card-body">
          <div class="grid grid-2">
            <div class="field">
              <label>1人あたり一括贈与額（初年度）</label>
              <input type="text" inputmode="numeric" id="multiSeisanInitialGift" placeholder="例）25,000,000" class="yen-input" />
              <small>シミュレーション開始時に、受贈者1人あたりにまとめて贈与する額。0円も可。</small>
            </div>
            <div class="field">
              <label>1人あたり毎年贈与額（2年目以降）</label>
              <input type="text" inputmode="numeric" id="multiSeisanAnnualGift" placeholder="例）1,100,000" class="yen-input" />
              <small>精算課税を選択後、受贈者1人あたりに毎年贈与する額。</small>
            </div>
          </div>
          <div class="grid grid-2" style="margin-top:12px;">
            <div class="field">
              <label>既に使用済みの特別控除額（1人あたり）</label>
              <input type="text" inputmode="numeric" id="multiSeisanUsedSpecialBefore" placeholder="例）0" class="yen-input" />
              <small>これまでに相続時精算課税で使った特別控除額（0〜25,000,000）。</small>
            </div>
          </div>
          <small style="display:block; margin-top:8px;">
              ※ STEP1で設定した「受贈者の人数」全員に対して、上記条件で贈与を行う前提で計算します（人数分の資産減少効果・税額が発生します）。
          </small>
          <div class="btn-row">
            <button type="button" class="btn-calc" id="runMultiSimBtn">
              <span class="btn-calc-icon">▶</span>
              <span>長期シミュレーションを実行</span>
            </button>
            <button type="button" class="btn-ghost" id="multiClearBtn">入力をクリア</button>
          </div>
        </div>
      </section>

      <section class="card result-card hidden print-break-before" id="multiResultCard">
        <div class="card-header">
          <h2 class="card-title">STEP3 長期シミュレーション結果（概算）</h2>
        </div>
        <div class="card-body">
          <p id="multiResultSummary" class="result-heading">前提条件と各シナリオの設定をもとに、暦年贈与シナリオと相続時精算課税シナリオの税負担・残財産を概算しています。</p>
          
          <div class="result-grid">
            <div class="metric">
              <div class="metric-label">暦年贈与シナリオ：トータル税負担</div>
              <div class="metric-value" id="multiAnnualTotalTax">- 円</div>
              <div class="metric-sub" id="multiAnnualTaxDetail">贈与税＋相続税額（概算）の合計</div>
            </div>
            <div class="metric">
              <div class="metric-label">暦年贈与シナリオ：相続時点の残財産</div>
              <div class="metric-value" id="multiAnnualFinalEstate">- 円</div>
              <div class="metric-sub">贈与後・運用後に残る相続財産（概算）</div>
            </div>
            <div class="metric">
              <div class="metric-label">相続時精算課税シナリオ：トータル税負担</div>
              <div class="metric-value" id="multiSeisanTotalTax">- 円</div>
              <div class="metric-sub" id="multiSeisanTaxDetail">贈与税＋相続税額（精算贈与税控除後）の合計</div>
            </div>
            <div class="metric">
              <div class="metric-label">相続時精算課税シナリオ：相続時点の残財産</div>
              <div class="metric-value" id="multiSeisanFinalEstate">- 円</div>
              <div class="metric-sub">贈与後・運用後に残る相続財産（概算）</div>
            </div>
            <div class="metric metric-featured">
              <div class="metric-label">税負担の差額（暦年 − 精算）</div>
              <div class="metric-value" id="multiTaxDiff">- 円</div>
              <div id="multiTaxAdvantage" style="font-weight:900; font-size:18px; margin-top:4px; color:var(--accent);"></div>
              <div class="metric-sub" id="multiTaxDiffSub">プラスなら相続時精算課税シナリオの方が税負担が軽い結果です。</div>
            </div>
            <div class="metric metric-featured">
              <div class="metric-label">最終手取金額の差額（精算 − 暦年）</div>
              <div class="metric-value" id="multiNetDiff">- 円</div>
              <div id="multiNetAdvantage" style="font-weight:900; font-size:18px; margin-top:4px; color:var(--accent);"></div>
              <div class="metric-sub" id="multiNetDiffSub">トータルの手取り（受贈分＋相続分−各税金）の差額です。※運用益の差等が影響します。</div>
            </div>
          </div>

          <!-- グラフ描画エリア -->
          <!-- クラスを追加して改ページ制御 -->
          <div class="print-break-before" style="display:flex; align-items:center; justify-content:space-between; margin:24px 0 12px; flex-wrap:wrap; gap:10px;">
            <h3 style="margin:0; font-size:16px; font-weight:700; color:var(--accent-dark);">
              シミュレーション結果の可視化
            </h3>
            <button type="button" class="btn-tutorial" id="toggleDetailsBtn" style="font-size:12px; padding:4px 10px;">詳細データを見る</button>
          </div>
          
          <div class="grid grid-2">
            <div>
              <div style="font-size:14px; font-weight:700; color:var(--muted); text-align:center;">① トータル税負担の内訳比較</div>
              <div class="chart-container">
                <canvas id="taxBreakdownChart"></canvas>
              </div>
              <div style="font-size:12px; color:var(--muted); margin-top:4px;">
                相続までに支払う「贈与税」と、相続時に支払う「相続税額」の合計負担額を比較します。
              </div>
            </div>
            <div>
              <div style="font-size:14px; font-weight:700; color:var(--muted); text-align:center;">② 資産残高の推移シミュレーション</div>
              <div class="chart-container">
                <canvas id="assetTransitionChart"></canvas>
              </div>
              <div style="font-size:12px; color:var(--muted); margin-top:4px;">
                贈与による資産の減少、運用による増加、そして相続税額支払による最終手取り額の推移を表します。
              </div>
            </div>
          </div>

          <!-- 詳細データテーブル（初期非表示） -->
          <!-- ここにも改ページ制御を追加 -->
          <div id="detailsArea" class="hidden print-break-before" style="margin-top:16px; overflow-x:auto; border-top:1px dashed var(--border); padding-top:16px;">
            <div style="font-size:14px; font-weight:700; margin-bottom:8px; color:var(--accent-dark);">▼ 年次シミュレーション詳細</div>
            <table class="detail-table" id="detailsTable">
              <thead>
                <tr>
                  <th rowspan="2">経過年</th>
                  <th colspan="3" style="border-bottom:1px solid #d4e1e7; background:#f0f8fa;">暦年贈与シナリオ</th>
                  <th colspan="3" style="border-bottom:1px solid #d4e1e7; background:#fff3f3;">精算課税シナリオ</th>
                </tr>
                <tr>
                  <th style="background:#f0f8fa;">贈与額(計)</th>
                  <th style="background:#f0f8fa;">贈与税(計)</th>
                  <th style="background:#f0f8fa;">期末資産</th>
                  <th style="background:#fff3f3;">贈与額(計)</th>
                  <th style="background:#fff3f3;">贈与税(計)</th>
                  <th style="background:#fff3f3;">期末資産</th>
                </tr>
              </thead>
              <tbody id="detailsTableBody">
                <!-- JSで生成 -->
              </tbody>
            </table>
            
            <!-- 追加：相続税計算の内訳表示エリア -->
            <div id="calcDetailsContainer" class="grid grid-2" style="margin-top:20px;">
              <!-- JSで生成 -->
            </div>

          </div>

        </div>
      </section>
    </div>

    <section class="card note-card" id="noteCard">
      <div class="card-header">
        <h2 class="card-title">ご利用上の注意</h2>
      </div>
      <div class="card-body">
        <ul>
          <li>本ツールは、令和7年4月1日現在の国税庁タックスアンサー（<a href="https://www.nta.go.jp/taxes/shiraberu/taxanswer/zoyo/4408.htm" target="_blank" rel="noopener noreferrer" style="color:var(--accent); text-decoration:underline;">No.4408「贈与税の計算と税率（暦年課税）」</a>、<a href="https://www.nta.go.jp/taxes/shiraberu/taxanswer/sozoku/4103.htm" target="_blank" rel="noopener noreferrer" style="color:var(--accent); text-decoration:underline;">No.4103「相続時精算課税の選択」</a>など）に基づき、贈与税額を概算するためのものです。</li>
          <li>土地・建物、有価証券の評価、各種非課税枠（配偶者控除、住宅取得資金の非課税、教育資金一括贈与 等）、特例税率の適用判定、相続税への生前贈与加算の詳細（7年加算・経過措置・100万円控除 等）については、本ツールでは簡略化しており、別途の検討が必要です。</li>
          <li>相続時精算課税については、令和6年1月1日以後の贈与に創設された年110万円の基礎控除と、累計2,500万円の特別控除を前提としています。</li>
          <li>長期シミュレーションの暦年贈与における相続財産への加算期間は、経過措置を考慮せず一律「相続前7年間」として概算しています。</li>
          <li>長期シミュレーションでは、贈与後の最終的な財産額（持ち戻し額を含む）に基づき、法定相続人が法定相続分通りに遺産を取得したと仮定して相続税額を計算しています。配偶者の有無や特例の適用等は考慮していないため、あくまで概算の目安としてご利用ください。</li>
          <li>「配偶者あり」を選択した場合、配偶者の法定相続分（1/2と仮定）相当額に対する税額軽減（配偶者は税金を負担しない）を考慮して相続税総額を算出します（全体の税額が概ね半減する計算となります）。</li>
        </ul>
        <div class="note-highlight">
          本ツールは税額の「概算」を把握することを目的としたものであり、申告書作成や申告是非の判断を直接行うものではありません。実務では、贈与の内容・時期・受贈者・贈与者の関係などを総合的に確認する必要があります。実際の贈与の実行・申告にあたっては、松本会計のスタッフにご相談ください。
        </div>
      </div>
    </section>

    <!-- 下部アクションボタン -->
    <section class="card" id="bottomActions">
      <div class="card-body">
        <div class="action-buttons">
          <button type="button" class="btn-soft" id="copyResultBtn">コピー</button>
          <button type="button" class="btn-soft" id="resetAllBtn">リセット</button>
          <button type="button" class="btn-outline" id="printBtn">印刷 / PDF保存</button>
        </div>
      </div>
    </section>

  </main>

  <footer class="mk-mini">
    © <span id="cpy-year">2025</span>
    <a href="https://www.matsumoto-kaikei.or.jp/" target="_blank" rel="noopener license">税理士法人松本会計事務所</a> ｜ 
    <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" target="_blank" rel="license noopener">CC BY-NC-SA 4.0</a> ｜ 
    <a href="/tool-portal/terms.html" target="_blank" rel="noopener">利用条件</a> ｜ 
    <span id="build-rev">Rev.25</span>（<span id="last-updated-date"></span>）
  </footer>
</div>

<script>
(function(){
  'use strict';

  const VERSION = 'Rev.25';

  // 年号 & 最終更新日を自動反映
  (function syncFooterMeta(){
    const yEl = document.getElementById('cpy-year');
    const dEl = document.getElementById('last-updated-date');
    const rEl = document.getElementById('build-rev');
    if(yEl){ yEl.textContent = String(new Date().getFullYear()); }
    if(dEl){
      const d = new Date(document.lastModified);
      const yyyy = String(d.getFullYear());
      const mm = String(d.getMonth()+1).padStart(2,'0');
      const dd = String(d.getDate()).padStart(2,'0');
      dEl.textContent = `${yyyy}-${mm}-${dd}`;
    }
    if(rEl){ rEl.textContent = VERSION; }
  })();

  // 定数
  const BASE_DEDUCTION = 1100000; // 暦年課税・相続時精算課税 共通の基礎控除額（110万円）
  const SEISAN_SPECIAL_LIMIT = 25000000; // 相続時精算課税の特別控除限度額（2,500万円）

  // 速算表
  const GENERAL_BRACKETS = [
    { upTo: 2000000, rate: 0.10, deduction: 0 },
    { upTo: 3000000, rate: 0.15, deduction: 100000 },
    { upTo: 4000000, rate: 0.20, deduction: 250000 },
    { upTo: 6000000, rate: 0.30, deduction: 650000 },
    { upTo: 10000000, rate: 0.40, deduction: 1250000 },
    { upTo: 15000000, rate: 0.45, deduction: 1750000 },
    { upTo: 30000000, rate: 0.50, deduction: 2500000 },
    { upTo: Infinity, rate: 0.55, deduction: 4000000 }
  ];

  const SPECIAL_BRACKETS = [
    { upTo: 2000000, rate: 0.10, deduction: 0 },
    { upTo: 4000000, rate: 0.15, deduction: 100000 },
    { upTo: 6000000, rate: 0.20, deduction: 300000 },
    { upTo: 10000000, rate: 0.30, deduction: 900000 },
    { upTo: 15000000, rate: 0.40, deduction: 1900000 },
    { upTo: 30000000, rate: 0.45, deduction: 2650000 },
    { upTo: 45000000, rate: 0.50, deduction: 4150000 },
    { upTo: Infinity, rate: 0.55, deduction: 6400000 }
  ];

  // 相続税速算表（平成27年1月1日以後）
  const INHERITANCE_TAX_BRACKETS = [
    { upTo: 10000000, rate: 0.10, deduction: 0 },
    { upTo: 30000000, rate: 0.15, deduction: 500000 },
    { upTo: 50000000, rate: 0.20, deduction: 2000000 },
    { upTo: 100000000, rate: 0.30, deduction: 7000000 },
    { upTo: 200000000, rate: 0.40, deduction: 17000000 },
    { upTo: 300000000, rate: 0.50, deduction: 42000000 },
    { upTo: 600000000, rate: 0.55, deduction: 72000000 },
    { upTo: Infinity, rate: 0.55, deduction: 72000000 } // 上限なしだが計算上必要
  ];

  // DOM取得（単年タブ）
  const modeRadios = document.querySelectorAll('input[name="mode"]');
  const annualCard = document.getElementById('annualCard');
  const seisanCard = document.getElementById('seisanCard');

  const annualModeRadios = document.querySelectorAll('input[name="annualMode"]');
  const annualGeneralOnly = document.getElementById('annualGeneralOnly');
  const annualSpecialOnly = document.getElementById('annualSpecialOnly');
  const annualBothGeneral = document.getElementById('annualBothGeneral');
  const annualBothSpecial = document.getElementById('annualBothSpecial');

  const annualGeneralAmount = document.getElementById('annualGeneralAmount');
  const annualSpecialAmount = document.getElementById('annualSpecialAmount');
  const annualGeneralAmountBoth = document.getElementById('annualGeneralAmountBoth');
  const annualSpecialAmountBoth = document.getElementById('annualSpecialAmountBoth');

  const seisanAmount = document.getElementById('seisanAmount');
  const seisanUsedSpecial = document.getElementById('seisanUsedSpecial');

  const calcAnnualBtn = document.getElementById('calcAnnualBtn');
  const calcSeisanBtn = document.getElementById('calcSeisanBtn');
  const annualClear = document.getElementById('annualClear');
  const seisanClear = document.getElementById('seisanClear');

  const resultSummary = document.getElementById('resultSummary');
  const resultTax = document.getElementById('resultTax');
  const resultTaxSub = document.getElementById('resultTaxSub');
  const resultBase = document.getElementById('resultBase');
  const resultBaseSub = document.getElementById('resultBaseSub');
  const resultRate = document.getElementById('resultRate');
  const resultRateSub = document.getElementById('resultRateSub');
  const metricRate = document.getElementById('metricRate');
  const metricSeisan = document.getElementById('metricSeisan');
  const resultSeisanSpecial = document.getElementById('resultSeisanSpecial');
  const resultSeisanUsedTotal = document.getElementById('resultSeisanUsedTotal');
  const resultSeisanSub = document.getElementById('resultSeisanSub');

  const copyResultBtn = document.getElementById('copyResultBtn');
  const resetAllBtn = document.getElementById('resetAllBtn');
  const printBtn = document.getElementById('printBtn');

  // タブ切替用DOM
  const tabModeRadios = document.querySelectorAll('input[name="tabMode"]');
  const singleModeArea = document.getElementById('singleModeArea');
  const multiModeArea = document.getElementById('multiModeArea');

  // 長期シミュレーション用DOM
  const multiEstateTotal = document.getElementById('multiEstateTotal');
  const multiYears = document.getElementById('multiYears');
  const multiReturnRate = document.getElementById('multiReturnRate');
  const multiRecipients = document.getElementById('multiRecipients'); 
  const multiHeirs = document.getElementById('multiHeirs');
  const multiSpouse = document.getElementById('multiSpouse'); // 配偶者有無チェック

  const multiAnnualGiftPerPerson = document.getElementById('multiAnnualGiftPerPerson');

  const multiSeisanInitialGift = document.getElementById('multiSeisanInitialGift');
  const multiSeisanAnnualGift = document.getElementById('multiSeisanAnnualGift');
  const multiSeisanUsedSpecialBefore = document.getElementById('multiSeisanUsedSpecialBefore');

  const runMultiSimBtn = document.getElementById('runMultiSimBtn');
  const multiClearBtn = document.getElementById('multiClearBtn');
  const loadSampleBtn = document.getElementById('loadSampleBtn');
  const multiResultCard = document.getElementById('multiResultCard');

  const multiResultSummary = document.getElementById('multiResultSummary');
  const multiAnnualTotalTax = document.getElementById('multiAnnualTotalTax');
  const multiAnnualFinalEstate = document.getElementById('multiAnnualFinalEstate');
  const multiSeisanTotalTax = document.getElementById('multiSeisanTotalTax');
  const multiSeisanFinalEstate = document.getElementById('multiSeisanFinalEstate');
  const multiTaxDiff = document.getElementById('multiTaxDiff');
  const multiTaxDiffSub = document.getElementById('multiTaxDiffSub');
  const multiTaxAdvantage = document.getElementById('multiTaxAdvantage');
  const multiNetDiff = document.getElementById('multiNetDiff');
  const multiNetAdvantage = document.getElementById('multiNetAdvantage');
  const multiNetDiffSub = document.getElementById('multiNetDiffSub');
  const multiAnnualTaxDetail = document.getElementById('multiAnnualTaxDetail');
  const multiSeisanTaxDetail = document.getElementById('multiSeisanTaxDetail');

  const toggleDetailsBtn = document.getElementById('toggleDetailsBtn');
  const detailsArea = document.getElementById('detailsArea');
  const detailsTableBody = document.getElementById('detailsTableBody');
  const calcDetailsContainer = document.getElementById('calcDetailsContainer');

  // グラフ用変数
  let taxBreakdownChart = null;
  let assetTransitionChart = null;

  // 全ての金額入力欄（カンマ整形）
  const yenInputs = document.querySelectorAll('.yen-input');

  // 【修正】リアルタイムカンマ入力 (IME対応版)
  yenInputs.forEach(input => {
    let isComposing = false;

    // IME入力開始
    input.addEventListener('compositionstart', () => {
      isComposing = true;
    });

    // IME入力終了
    input.addEventListener('compositionend', (e) => {
      isComposing = false;
      // 確定後の値を即フォーマット
      formatInputValue(e.target);
    });

    // 入力イベント
    input.addEventListener('input', (e) => {
      // IME変換中でなければフォーマット実行
      if (!isComposing) {
        formatInputValue(e.target);
      }
    });

    // フォーマット処理関数
    function formatInputValue(el) {
      // カーソル位置の保持用（簡易的な実装）
      const val = el.value;
      if (!val) return;

      // 全角数字を半角に
      const normalized = val.replace(/[０-９]/g, s => String.fromCharCode(s.charCodeAt(0) - 0xFEE0));
      // 数字以外を除去
      const raw = normalized.replace(/[^0-9]/g, '');

      if (raw) {
        // カンマ区切り
        const formatted = Number(raw).toLocaleString('ja-JP');
        // 値が変更になる場合のみ更新（カーソル飛び防止のため）
        if (el.value !== formatted) {
          el.value = formatted;
        }
      } else {
        el.value = '';
      }
    }

    // フォーカス時全選択 (使いやすさ向上)
    input.addEventListener('focus', function() {
      this.select();
    });
  });

  // ユーティリティ
  function parseYenInput(el){
    if(!el) return 0;
    const raw = (el.value || '').replace(/[\s,]/g,'');
    if(!raw) return 0;
    const n = Number(raw);
    return Number.isFinite(n) ? Math.floor(n) : 0;
  }

  function formatYen(n){
    if(!Number.isFinite(n)) return '-';
    return n.toLocaleString('ja-JP');
  }

  function roundTax100(n){
    if(!Number.isFinite(n) || n <= 0) return 0;
    return Math.floor(n / 100) * 100;
  }

  // 課税価格の千円未満切捨て
  function truncateToThousand(n){
    if(!Number.isFinite(n) || n <= 0) return 0;
    return Math.floor(n / 1000) * 1000;
  }

  function calcTaxFromTable(taxBase, brackets){
    if(taxBase <= 0) return { tax:0, rate:null, deduction:null };
    const b = brackets.find(br => taxBase <= br.upTo) || brackets[brackets.length - 1];
    const tax = taxBase * b.rate - b.deduction;
    return { tax: tax, rate: b.rate, deduction: b.deduction };
  }

  function parseNumber(el, defaultValue){
    if(!el) return defaultValue;
    const val = String(el.value || '').trim();
    if(!val) return defaultValue;
    const n = Number(val);
    return Number.isFinite(n) ? n : defaultValue;
  }

  // 新しい相続税計算関数 (法定相続人の数と遺産総額から総額を算出)
  // 戻り値: { totalTax: number, deduction: number, taxable: number }
  function calcInheritanceTaxData(estateTotal, heirsCount) {
    if (estateTotal <= 0 || heirsCount <= 0) return { totalTax:0, deduction:0, taxable:0 };
    
    // 基礎控除
    const deduction = 30000000 + 6000000 * heirsCount;
    // 課税遺産総額
    const taxable = Math.max(0, estateTotal - deduction);
    
    if (taxable <= 0) return { totalTax:0, deduction, taxable:0 };
    
    // 法定相続分で按分（全員均等と仮定）
    
    const share = Math.floor(taxable / heirsCount);
    const bracket = INHERITANCE_TAX_BRACKETS.find(b => share <= b.upTo) || INHERITANCE_TAX_BRACKETS[INHERITANCE_TAX_BRACKETS.length-1];
    const taxPerHeir = share * bracket.rate - bracket.deduction;
    const totalTax = Math.floor(taxPerHeir * heirsCount);
    
    return { totalTax, deduction, taxable };
  }

  // ===== チュートリアル =====
  const TOUR_KEY = 'gift_tax_tour_dismissed_v1';
  // STEP5, STEP6（結果表示）は削除
  const steps = [
    {
      sel: '.brand',
      title: 'ツール概要',
      body: 'このツールでは、暦年課税（一般・特例）と相続時精算課税について、1人の受贈者あたり1年間の贈与税額を概算でき、長期シミュレーションタブでは暦年贈与と相続時精算課税の有利不利を概算比較できます。'
    },
    {
      sel: '#tabSwitch',
      title: 'モード選択',
      body: '「単年試算」と「長期シミュレーション」をタブ形式で切り替えます。まずはどちらを使うかを選択してください。'
    },
    {
      sel: '#modeSwitch',
      title: '単年試算：計算方法の選択',
      body: '単年試算タブでは、暦年課税か相続時精算課税かを選択し、1年分の贈与税額を概算します。'
    },
    {
      sel: '#multiCommonCard',
      title: '長期シミュレーション：前提条件',
      body: '長期シミュレーションタブでは、相続財産総額や相続までの年数、受贈者の人数などを入力してシミュレーションを行います。配偶者の有無も選択可能です。'
    }
  ];

  let tourIndex = 0;
  let maskEl, focusEl, panelEl, prevBtn, nextBtn, skipBtn, titleEl2, bodyEl2, stepEl2;
  let elevatedEl = null;

  const qs = sel => document.querySelector(sel);
  const vv = () => window.visualViewport || null;
  const vvOffsetX = () => { const v = vv(); return v ? v.offsetLeft : 0; };
  const vvOffsetY = () => { const v = vv(); return v ? v.offsetTop : 0; };
  const vvWidth = () => { const v = vv(); return v ? v.width : window.innerWidth; };
  const vvHeight = () => { const v = vv(); return v ? v.height : window.innerHeight; };

  function stableScrollIntoView(el){
    return new Promise(resolve => {
      if(!el){ resolve(); return; }
      let done = false;
      const timer = setTimeout(() => {
        if(done) return;
        done = true;
        resolve();
      }, 350);
      const finish = () => {
        if(done) return;
        done = true;
        clearTimeout(timer);
        resolve();
      };
      const onEnd = () => {
        window.removeEventListener('scrollend', onEnd);
        finish();
      };
      window.addEventListener('scrollend', onEnd, { once:true });
      el.scrollIntoView({ block:'center', behavior:'smooth' });
      requestAnimationFrame(() => requestAnimationFrame(() => {}));
    });
  }

  function rectInVisualViewport(el){
    const r = el.getBoundingClientRect();
    const x = Math.round(r.left + vvOffsetX());
    const y = Math.round(r.top + vvOffsetY());
    const w = Math.round(Math.min(r.width, vvWidth() - 16));
    const h = Math.round(Math.min(r.height, vvHeight() - 16));
    const pad = 8;
    return {
      x: Math.max(8 + vvOffsetX(), x - pad),
      y: Math.max(8 + vvOffsetY(), y - pad),
      w: Math.max(24, w + pad * 2),
      h: Math.max(24, h + pad * 2)
    };
  }

  function placeFocus(){
    if(!panelEl || !focusEl) return;
    
    // 修正: チュートリアル非表示なら何もしない
    if(panelEl.style.display === 'none') return;

    const step = steps[tourIndex];

    if(step.sel === '#modeSwitch'){
      const r = document.querySelector('input[name="tabMode"][value="single"]');
      if(r && !r.checked){ r.checked = true; updateTabMode(); }
      const r2 = document.querySelector('input[name="mode"][value="annual"]');
      if(r2 && !r2.checked){ r2.checked = true; updateMode(); }
    }else if(step.sel === '#multiCommonCard'){
      const r = document.querySelector('input[name="tabMode"][value="multi"]');
      if(r && !r.checked){ r.checked = true; updateTabMode(); }
    }

    const target = qs(step.sel);
    if(!target) return;

    if(elevatedEl && elevatedEl !== target){
      elevatedEl.classList.remove('mk-tour-elevate');
    }
    target.classList.add('mk-tour-elevate');
    elevatedEl = target;

    const rct = rectInVisualViewport(target);
    focusEl.style.left = rct.x + 'px';
    focusEl.style.top = rct.y + 'px';
    focusEl.style.width = rct.w + 'px';
    focusEl.style.height = rct.h + 'px';

    const panelW = Math.min(560, vvWidth() * 0.92);
    const margin = 12;
    const belowY = rct.y + rct.h + margin;
    const aboveY = Math.max(8 + vvOffsetY(), rct.y - margin - 170);
    let px = Math.min(Math.max(8 + vvOffsetX(), rct.x), vvOffsetX() + vvWidth() - panelW - 8);
    let py = (belowY + 190 < vvOffsetY() + vvHeight()) ? belowY : aboveY;

    panelEl.style.left = px + 'px';
    panelEl.style.top = py + 'px';
    panelEl.style.maxWidth = panelW + 'px';

    stepEl2.textContent = 'STEP ' + (tourIndex + 1) + ' / ' + steps.length;
    titleEl2.textContent = step.title;
    bodyEl2.innerHTML = step.body;

    prevBtn.disabled = tourIndex === 0;
    nextBtn.textContent = (tourIndex === steps.length - 1) ? '完了' : '次へ';
  }

  function ensureEls(){
    if(maskEl) return;
    maskEl = document.createElement('div');
    maskEl.className = 'mk-tour-mask';
    maskEl.tabIndex = -1;
    focusEl = document.createElement('div');
    focusEl.className = 'mk-tour-focus';
    focusEl.setAttribute('aria-hidden','true');
    panelEl = document.createElement('div');
    panelEl.className = 'mk-tour-panel';
    const head = document.createElement('div');
    head.className = 'mk-tour-head';
    stepEl2 = document.createElement('div');
    stepEl2.className = 'mk-tour-step';
    titleEl2 = document.createElement('div');
    titleEl2.className = 'mk-tour-title';
    head.append(stepEl2, titleEl2);
    bodyEl2 = document.createElement('div');
    bodyEl2.className = 'mk-tour-body';
    const actions = document.createElement('div');
    actions.className = 'mk-tour-actions';
    prevBtn = document.createElement('button');
    prevBtn.className = 'tbtn';
    prevBtn.textContent = '前へ';
    skipBtn = document.createElement('button');
    skipBtn.className = 'tbtn';
    skipBtn.textContent = 'スキップ';
    nextBtn = document.createElement('button');
    nextBtn.className = 'tbtn primary';
    nextBtn.textContent = '次へ';
    actions.append(prevBtn, skipBtn, nextBtn);
    panelEl.append(head, bodyEl2, actions);
    document.body.append(maskEl, focusEl, panelEl);

    skipBtn.addEventListener('click', endTour);
    prevBtn.addEventListener('click', async () => {
      if(tourIndex > 0){
        tourIndex--;
        placeFocus();
        await stableScrollIntoView(qs(steps[tourIndex].sel));
        placeFocus();
      }
    });
    nextBtn.addEventListener('click', async () => {
      if(tourIndex < steps.length - 1){
        tourIndex++;
        placeFocus();
        await stableScrollIntoView(qs(steps[tourIndex].sel));
        placeFocus();
      }else{
        endTour();
      }
    });
    // キーボード操作の修正
    document.addEventListener('keydown', function(e){
      // パネルが表示されていない時は無視
      if(!panelEl || panelEl.style.display === 'none') return;
      
      if(e.key === 'Escape'){
        endTour();
        e.preventDefault();
      }else if(e.key === 'ArrowRight' || e.key === 'Enter'){
        e.preventDefault(); // ボタンフォーカス時の重複発火防止
        nextBtn.click();
      }else if(e.key === 'ArrowLeft'){
        e.preventDefault();
        prevBtn.click();
      }
    });
    maskEl.addEventListener('click', () => { nextBtn.click(); });
    const v = vv();
    if(v){
      v.addEventListener('resize', placeFocus);
      v.addEventListener('scroll', placeFocus);
    }
    window.addEventListener('resize', placeFocus, { passive:true });
    window.addEventListener('scroll', placeFocus, { passive:true });
    window.addEventListener('orientationchange', () => setTimeout(placeFocus, 100));
  }

  function trackTutorial(eventName, params){
    try{
      if(typeof window.gtag === 'function'){
        window.gtag('event', eventName, params || {});
      }
    }catch(e){}
  }

  async function startTour(idx){
    if(typeof idx !== 'number') idx = 0;
    trackTutorial('tutorial_start',{ step: idx + 1 });
    ensureEls();
    tourIndex = idx;
    maskEl.style.display = 'block';
    focusEl.style.display = 'block';
    panelEl.style.display = 'block';
    document.body.style.overflow = 'hidden';
    placeFocus();
    const target = qs(steps[tourIndex].sel);
    if(target){ await stableScrollIntoView(target); }
    requestAnimationFrame(() => {
      requestAnimationFrame(placeFocus);
    });
    nextBtn.focus();
  }

  function endTour(){
    trackTutorial('tutorial_end',{ completed: tourIndex === steps.length - 1 });
    if(maskEl) maskEl.style.display = 'none';
    if(focusEl) focusEl.style.display = 'none';
    if(panelEl) panelEl.style.display = 'none';
    document.body.style.overflow = '';
    if(elevatedEl){
      elevatedEl.classList.remove('mk-tour-elevate');
      elevatedEl = null;
    }
    try{
      localStorage.setItem(TOUR_KEY,'1');
    }catch(e){}
  }

  const tourBtn = document.getElementById('startTour');
  if(tourBtn){ tourBtn.addEventListener('click', () => { startTour(0); }); }

  // ===== タブ切替 =====
  function updateTabMode(){
    const mode = document.querySelector('input[name="tabMode"]:checked')?.value || 'single';
    if(mode === 'single'){
      singleModeArea.classList.remove('hidden');
      multiModeArea.classList.add('hidden');
    }else{
      singleModeArea.classList.add('hidden');
      multiModeArea.classList.remove('hidden');
    }
  }

  tabModeRadios.forEach(r => r.addEventListener('change', updateTabMode));

  // ===== 単年タブ：モード切替 =====
  function updateMode(){
    const mode = document.querySelector('input[name="mode"]:checked')?.value || 'annual';
    if(mode === 'annual'){
      annualCard.classList.remove('hidden');
      seisanCard.classList.add('hidden');
      metricRate.classList.remove('hidden');
      metricSeisan.classList.add('hidden');
      resultSummary.textContent = '暦年課税（一般税率・特例税率）による贈与税額の概算結果です。';
      resultBaseSub.textContent = '暦年課税：年間の贈与額の合計 − 110万円（基礎控除）を控除した後の課税価格（千円未満切捨て）';
      resultRateSub.textContent = '国税庁 速算表（一般贈与財産用／特例贈与財産用）に基づき計算';
      resultTaxSub.textContent = '暦年課税：課税価格は千円未満切捨て／税額は100円未満切捨ての概算額です。';
    }else{
      annualCard.classList.add('hidden');
      seisanCard.classList.remove('hidden');
      metricRate.classList.add('hidden');
      metricSeisan.classList.remove('hidden');
      resultSummary.textContent = '相続時精算課税（年110万円の基礎控除＋特別控除2,500万円）による贈与税額の概算結果です。';
      resultBaseSub.textContent = '相続時精算課税：基礎控除110万円・特別控除適用後の課税価格（千円未満切捨て）';
      resultTaxSub.textContent = '相続時精算課税：課税価格は千円未満切捨て／税額は20％・100円未満切捨ての概算額です。';
    }
  }

  // 暦年課税：入力欄の切替
  function updateAnnualInputs(){
    const mode = document.querySelector('input[name="annualMode"]:checked')?.value || 'general';
    [annualGeneralOnly, annualSpecialOnly, annualBothGeneral, annualBothSpecial].forEach(el => el.classList.add('hidden'));
    if(mode === 'general'){
      annualGeneralOnly.classList.remove('hidden');
    }else if(mode === 'special'){
      annualSpecialOnly.classList.remove('hidden');
    }else{
      annualBothGeneral.classList.remove('hidden');
      annualBothSpecial.classList.remove('hidden');
    }
  }

  // ===== 単年：暦年課税計算 =====
  function handleCalcAnnual(){
    const mode = document.querySelector('input[name="annualMode"]:checked')?.value || 'general';
    let generalTotal = 0;
    let specialTotal = 0;
    let taxBase = 0;
    let taxAmount = 0;
    let summaryText = '';
    let rateText = '-';

    if(mode === 'general'){
      generalTotal = parseYenInput(annualGeneralAmount);
      const total = generalTotal;
      if(total <= 0){
        resetResult();
        resultSummary.textContent = '一般贈与財産の金額を入力してください。';
        return;
      }
      taxBase = Math.max(0, total - BASE_DEDUCTION);
      taxBase = truncateToThousand(taxBase);
      const general = calcTaxFromTable(taxBase, GENERAL_BRACKETS);
      taxAmount = roundTax100(general.tax);
      summaryText = '一般贈与財産のみ（暦年課税）として試算しています。';
      rateText = general.rate ? (Math.round(general.rate * 100) + '%／控除額 ' + formatYen(general.deduction) + '円') : '-';

    }else if(mode === 'special'){
      specialTotal = parseYenInput(annualSpecialAmount);
      const total = specialTotal;
      if(total <= 0){
        resetResult();
        resultSummary.textContent = '特例贈与財産の金額を入力してください。';
        return;
      }
      taxBase = Math.max(0, total - BASE_DEDUCTION);
      taxBase = truncateToThousand(taxBase);
      const special = calcTaxFromTable(taxBase, SPECIAL_BRACKETS);
      taxAmount = roundTax100(special.tax);
      summaryText = '特例贈与財産のみ（暦年課税）として試算しています。';
      rateText = special.rate ? (Math.round(special.rate * 100) + '%／控除額 ' + formatYen(special.deduction) + '円') : '-';

    }else{
      generalTotal = parseYenInput(annualGeneralAmountBoth);
      specialTotal = parseYenInput(annualSpecialAmountBoth);
      const total = generalTotal + specialTotal;
      if(total <= 0){
        resetResult();
        resultSummary.textContent = '一般贈与財産・特例贈与財産のいずれかに金額を入力してください。';
        return;
      }
      taxBase = Math.max(0, total - BASE_DEDUCTION);
      taxBase = truncateToThousand(taxBase);
      if(taxBase <= 0){
        taxAmount = 0;
        summaryText = '年間の贈与額の合計が基礎控除額（110万円）以下のため、贈与税はかかりません（暦年課税）。';
        rateText = '-';
      }else{
        const asGeneral = calcTaxFromTable(taxBase, GENERAL_BRACKETS);
        const asSpecial = calcTaxFromTable(taxBase, SPECIAL_BRACKETS);
        const totalTaxGeneral = asGeneral.tax;
        const totalTaxSpecial = asSpecial.tax;

        const shareGeneral = generalTotal / (generalTotal + specialTotal || 1);
        const shareSpecial = specialTotal / (generalTotal + specialTotal || 1);

        const taxGeneralPortion = totalTaxGeneral * shareGeneral;
        const taxSpecialPortion = totalTaxSpecial * shareSpecial;

        taxAmount = roundTax100(taxGeneralPortion + taxSpecialPortion);

        summaryText = '一般贈与財産と特例贈与財産の両方があるため、国税庁の計算例に基づき按分計算を行っています。';
        rateText = '一般税率・特例税率による按分計算（合計課税価格 ' + formatYen(taxBase) + '円ベース）';
      }
    }

    resultTax.textContent = formatYen(taxAmount) + ' 円';
    resultTaxSub.textContent = '暦年課税：課税価格は千円未満切捨て／税額は100円未満切捨ての概算額です。';
    resultBase.textContent = formatYen(taxBase) + ' 円';
    resultSummary.textContent = summaryText;
    resultRate.textContent = rateText;

    metricSeisan.classList.add('hidden');
    metricRate.classList.remove('hidden');
    resultSeisanSpecial.textContent = '- 円';
    resultSeisanUsedTotal.textContent = '- 円';
    resultSeisanSub.textContent = '累計特別控除利用額：- 円';
  }

  // ===== 単年：相続時精算課税計算 =====
  function handleCalcSeisan(){
    const amount = parseYenInput(seisanAmount);
    let usedBefore = parseYenInput(seisanUsedSpecial);

    if(amount <= 0){
      resetResult();
      resultSummary.textContent = '相続時精算課税の対象となる当年の贈与額を入力してください。';
      return;
    }

    if(usedBefore < 0) usedBefore = 0;
    if(usedBefore > SEISAN_SPECIAL_LIMIT) usedBefore = SEISAN_SPECIAL_LIMIT;

    const baseAfterKiso = Math.max(0, amount - BASE_DEDUCTION);
    const remainingSpecial = Math.max(0, SEISAN_SPECIAL_LIMIT - usedBefore);
    const specialThisYear = Math.min(baseAfterKiso, remainingSpecial);
    const taxableAfterSpecial = Math.max(0, baseAfterKiso - specialThisYear);

    const taxBase = truncateToThousand(taxableAfterSpecial);
    const rawTax = taxBase * 0.20;
    const tax = roundTax100(rawTax);
    const usedAfter = usedBefore + specialThisYear;

    resultTax.textContent = formatYen(tax) + ' 円';
    resultTaxSub.textContent = '相続時精算課税：課税価格は千円未満切捨て／税額は20％・100円未満切捨ての概算額です。';
    resultBase.textContent = formatYen(taxBase) + ' 円';
    resultBaseSub.textContent = '当年の贈与額 − 110万円 − 特別控除額等を控除した後の課税価格（千円未満切捨て）';
    resultSummary.textContent = '相続時精算課税（特定贈与者 1人分）として、基礎控除110万円と特別控除2,500万円の残額を考慮して試算しています。';

    metricRate.classList.add('hidden');
    metricSeisan.classList.remove('hidden');
    resultRate.textContent = '-';

    resultSeisanSpecial.textContent = formatYen(specialThisYear) + ' 円';
    resultSeisanUsedTotal.textContent = formatYen(usedAfter) + ' 円';
    resultSeisanSub.textContent = '累計特別控除利用額：' + formatYen(usedAfter) + ' 円（上限 25,000,000 円）';
  }

  // 単年結果リセット
  function resetResult(){
    resultTax.textContent = '- 円';
    resultTaxSub.textContent = '（課税価格は千円未満切捨て／税額は100円未満切捨て）';
    resultBase.textContent = '- 円';
    resultBaseSub.textContent = '基礎控除等控除後の課税価格（千円未満切捨て前）';
    resultRate.textContent = '-';
    resultSeisanSpecial.textContent = '- 円';
    resultSeisanUsedTotal.textContent = '- 円';
    resultSeisanSub.textContent = '累計特別控除利用額：- 円';
  }

  function clearAnnual(){
    [annualGeneralAmount, annualSpecialAmount, annualGeneralAmountBoth, annualSpecialAmountBoth].forEach(el => {
      if(el) el.value = '';
    });
    resetResult();
  }

  function clearSeisan(){
    if(seisanAmount) seisanAmount.value = '';
    if(seisanUsedSpecial) seisanUsedSpecial.value = '';
    resetResult();
  }

  // ===== 長期シミュレーション計算 =====
  function resetMultiResult(){
    multiResultSummary.textContent = '前提条件と各シナリオの設定をもとに、暦年贈与シナリオと相続時精算課税シナリオの税負担・残財産を概算しています。';
    multiAnnualTotalTax.textContent = '- 円';
    multiAnnualFinalEstate.textContent = '- 円';
    multiSeisanTotalTax.textContent = '- 円';
    multiSeisanFinalEstate.textContent = '- 円';
    multiTaxDiff.textContent = '- 円';
    multiTaxDiffSub.textContent = 'プラスなら相続時精算課税シナリオの方が税負担が軽い結果です。';
    multiTaxAdvantage.textContent = '';
    multiNetDiff.textContent = '- 円';
    multiNetAdvantage.textContent = '';
    multiNetDiffSub.textContent = 'トータルの手取り（受贈分＋相続分−各税金）の差額です。※運用益の差等が影響します。';
    multiAnnualTaxDetail.textContent = '贈与税＋相続税額（概算）の合計';
    multiSeisanTaxDetail.textContent = '贈与税＋相続税額（精算贈与税控除後）の合計';
    multiResultCard.classList.add('hidden');
    detailsArea.classList.add('hidden');
    detailsTableBody.innerHTML = '';
    calcDetailsContainer.innerHTML = '';

    if(taxBreakdownChart) { taxBreakdownChart.destroy(); taxBreakdownChart = null; }
    if(assetTransitionChart) { assetTransitionChart.destroy(); assetTransitionChart = null; }
  }

  function clearMultiInputs(){
    if(multiEstateTotal) multiEstateTotal.value = '';
    if(multiYears) multiYears.value = '';
    if(multiReturnRate) multiReturnRate.value = '';
    // multiEffRate削除済み
    if(multiAnnualGiftPerPerson) multiAnnualGiftPerPerson.value = '';
    if(multiRecipients) multiRecipients.value = ''; 
    if(multiHeirs) multiHeirs.value = '';
    if(multiSpouse) multiSpouse.checked = false;
    if(multiSeisanInitialGift) multiSeisanInitialGift.value = '';
    if(multiSeisanAnnualGift) multiSeisanAnnualGift.value = '';
    if(multiSeisanUsedSpecialBefore) multiSeisanUsedSpecialBefore.value = '';
    resetMultiResult();
  }

  // サンプルデータ読込
  function loadSampleData(){
    if(multiEstateTotal) multiEstateTotal.value = '150,000,000';
    if(multiYears) multiYears.value = '10';
    if(multiReturnRate) multiReturnRate.value = '1.0';
    if(multiRecipients) multiRecipients.value = '2';
    if(multiHeirs) multiHeirs.value = '3'; // ここを変更
    if(multiSpouse) multiSpouse.checked = true;
    if(multiAnnualGiftPerPerson) multiAnnualGiftPerPerson.value = '3,100,000';
    if(multiSeisanInitialGift) multiSeisanInitialGift.value = '25,000,000';
    if(multiSeisanAnnualGift) multiSeisanAnnualGift.value = '1,100,000';
    if(multiSeisanUsedSpecialBefore) multiSeisanUsedSpecialBefore.value = '0';
    
    // カンマ整形用イベント発火
    [multiEstateTotal, multiAnnualGiftPerPerson, multiSeisanInitialGift, multiSeisanAnnualGift, multiSeisanUsedSpecialBefore].forEach(el => {
      if(el) el.dispatchEvent(new Event('input')); 
    });
  }

  // 計算詳細のHTML生成
  function renderCalcDetail(title, estateVal, addback, addbackNote, deduction, taxable, totalTaxBeforeCredit, spouseCredit, finalTax, creditName, creditAmount){
    let creditHtml = '';
    if(creditAmount && creditAmount > 0){
      creditHtml = `
        <div class="calc-row deduction-row">
          <span>${creditName}</span>
          <span>▲ ${formatYen(Math.round(creditAmount))} 円</span>
        </div>
      `;
    }

    return `
      <div class="calc-detail-box">
        <div class="calc-detail-title">${title}</div>
        <div class="calc-row">
          <span>期末資産額</span>
          <span>${formatYen(Math.round(estateVal))} 円</span>
        </div>
        <div class="calc-row">
          <span>＋ 持戻し額</span>
          <span>${formatYen(Math.round(addback))} 円</span>
        </div>
        <div class="calc-note" style="text-align:right; margin-bottom:4px;">
          （${addbackNote}）
        </div>
        <div class="calc-row">
          <span>（A）課税価格の合計額</span>
          <span style="font-weight:bold;">${formatYen(Math.round(estateVal + addback))} 円</span>
        </div>
        <div class="calc-row deduction-row">
          <span>（B）基礎控除額</span>
          <span>▲ ${formatYen(deduction)} 円</span>
        </div>
        <div class="calc-note" style="text-align:right;">
          （3,000万円 ＋ 600万円 × 法定相続人数）
        </div>
        <div class="calc-row" style="margin-top:4px;">
          <span>（C）課税遺産総額 (A-B)</span>
          <span>${formatYen(Math.round(taxable))} 円</span>
        </div>
        <div style="border-bottom:1px solid #eee; margin:6px 0;"></div>
        <div class="calc-row">
          <span>相続税総額（税額控除前）</span>
          <span>${formatYen(Math.round(totalTaxBeforeCredit))} 円</span>
        </div>
        ${spouseCredit > 0 ? `
        <div class="calc-row deduction-row">
          <span>配偶者の税額軽減</span>
          <span>▲ ${formatYen(Math.round(spouseCredit))} 円</span>
        </div>
        <div class="calc-note" style="text-align:right;">（法定相続分相当として50%減額）</div>
        ` : ''}
        ${creditHtml}
        <div class="calc-row sum-row">
          <span>最終的な相続税額</span>
          <span style="color:var(--accent);">${formatYen(Math.round(finalTax))} 円</span>
        </div>
      </div>
    `;
  }

  function handleMultiSim(){
    const estate0 = parseYenInput(multiEstateTotal);
    const yearsRaw = parseNumber(multiYears, 0);
    let years = Math.floor(yearsRaw);
    if(years <= 0){
      resetMultiResult();
      alert('相続までの想定年数を1年以上で入力してください。');
      return;
    }
    if(estate0 <= 0){
      resetMultiResult();
      alert('現在の相続財産総額を入力してください。');
      return;
    }

    let r = parseNumber(multiReturnRate, 0) / 100;
    if(!Number.isFinite(r) || r < -1) r = 0;

    const giftPerPersonA = parseYenInput(multiAnnualGiftPerPerson);
    
    let recipients = parseNumber(multiRecipients, 0);
    recipients = Math.floor(recipients);
    if(recipients < 0) recipients = 0;

    let heirs = parseNumber(multiHeirs, 0);
    heirs = Math.floor(heirs);
    if(heirs < 0) heirs = 0;
    
    // 配偶者有無
    const hasSpouse = multiSpouse.checked;

    const initialGiftB = parseYenInput(multiSeisanInitialGift);
    const annualGiftB = parseYenInput(multiSeisanAnnualGift);
    let usedSpecialBeforeB = parseYenInput(multiSeisanUsedSpecialBefore);
    if(usedSpecialBeforeB < 0) usedSpecialBeforeB = 0;
    if(usedSpecialBeforeB > SEISAN_SPECIAL_LIMIT) usedSpecialBeforeB = SEISAN_SPECIAL_LIMIT;

    // グラフ用データ配列
    const chartLabels = [];
    const dataAssetA = [estate0]; // 暦年: 資産推移
    const dataAssetB = [estate0]; // 精算: 資産推移

    for(let i=0; i<=years; i++){
      chartLabels.push(''+i+'年後');
    }

    // ---- 暦年贈与シナリオ (A) ----
    let estateA = estate0;
    let totalGiftTaxA = 0;
    let addbackListA = [];
    let totalGiftAmountA = 0; // 贈与額累計(税引前)
    const annualHistoryA = []; // { giftTotal, taxYear, estateEnd }

    for(let t=1; t<=years; t++){
      const plannedGiftTotal = giftPerPersonA * recipients;
      let giftTotal = plannedGiftTotal;
      if(estateA <= 0 || plannedGiftTotal <= 0){
        giftTotal = 0;
      }else if(plannedGiftTotal > estateA){
        giftTotal = estateA; 
      }

      let taxYear = 0;
      if(giftTotal > 0 && recipients > 0){
        const perGift = giftTotal / recipients;
        const basePer = Math.max(0, perGift - BASE_DEDUCTION);
        const taxBasePer = truncateToThousand(basePer);
        const taxInfoPer = calcTaxFromTable(taxBasePer, SPECIAL_BRACKETS); 
        const taxPer = roundTax100(taxInfoPer.tax);
        taxYear = taxPer * recipients;
        totalGiftTaxA += taxYear;
      }
      totalGiftAmountA += giftTotal;

      const addbackYear = giftTotal; 
      addbackListA.push(addbackYear);

      estateA = Math.max(0, estateA - giftTotal);
      estateA = estateA * (1 + r);
      dataAssetA.push(estateA);
      
      annualHistoryA.push({ giftTotal, taxYear, estateEnd: estateA });
    }

    let addbackA = 0;
    const yearsForAddback = Math.min(years, 7);
    for(let i=0; i<yearsForAddback; i++){
      const idx = addbackListA.length - 1 - i;
      if(idx >= 0){ addbackA += addbackListA[idx]; }
    }

    const estateBaseA = estateA + addbackA;
    // 相続税計算 (A)
    const taxDataA = calcInheritanceTaxData(estateBaseA, heirs);
    let estateTaxTotalA = taxDataA.totalTax;
    let spouseCreditA = 0;
    
    // 配偶者軽減 (A)
    if(hasSpouse && estateTaxTotalA > 0) {
      // 簡易的に50%軽減
      spouseCreditA = Math.floor(estateTaxTotalA * 0.5);
      estateTaxTotalA -= spouseCreditA;
    }

    // 暦年贈与の贈与税額控除計算 (持ち戻し対象期間の贈与税を控除)
    let giftTaxCreditA = 0;
    const historyLen = annualHistoryA.length;
    for(let i=0; i<yearsForAddback; i++){
        const idx = historyLen - 1 - i;
        if(idx >= 0){
            giftTaxCreditA += annualHistoryA[idx].taxYear;
        }
    }
    
    // 相続税から控除 (マイナスにはならない)
    let netEstateTaxA = Math.max(0, estateTaxTotalA - giftTaxCreditA);

    // トータル税負担 = 支払った贈与税 + 最終的に支払う相続税
    const totalTaxA = totalGiftTaxA + netEstateTaxA;
    // 最終手取り (残財産 - 最終的な相続税)
    // ※生前贈与の手取りは別途 totalGiftAmountA - totalGiftTaxA で計算される
    const finalNetA = Math.max(0, estateA - netEstateTaxA);

    // 実効税率(A)参考
    const effectiveRateA = (estateBaseA > 0) ? (estateTaxTotalA / estateBaseA) * 100 : 0;

    // ---- 相続時精算課税シナリオ (B) ----
    let estateB = estate0;
    let totalGiftTaxB = 0;
    let addbackB = 0;
    let totalGiftAmountB = 0; // 贈与額累計(税引前)
    let remainingSpecialPerPerson = Math.max(0, SEISAN_SPECIAL_LIMIT - usedSpecialBeforeB);
    const annualHistoryB = [];

    // 年1：一括贈与
    if(initialGiftB > 0 && estateB > 0){
      let plannedTotal = initialGiftB * recipients;
      let actualTotal = plannedTotal;
      if(actualTotal > estateB) actualTotal = estateB;
      
      let perGift = (recipients > 0) ? actualTotal / recipients : 0;
      let taxYear = 0;

      if(perGift > 0){
        const baseAfterKiso = Math.max(0, perGift - BASE_DEDUCTION);
        const specialUse = Math.min(baseAfterKiso, remainingSpecialPerPerson);
        remainingSpecialPerPerson -= specialUse;
        
        const taxable = Math.max(0, baseAfterKiso - specialUse);
        const taxBase = truncateToThousand(taxable);
        const rawTax = taxBase * 0.20;
        const taxPerPerson = roundTax100(rawTax);
        
        taxYear = taxPerPerson * recipients;
        totalGiftTaxB += taxYear;
        
        const addbackPer = Math.max(0, perGift - BASE_DEDUCTION);
        addbackB += addbackPer * recipients;
      }
      totalGiftAmountB += actualTotal;

      estateB = Math.max(0, estateB - actualTotal);
      estateB = estateB * (1 + r);
      dataAssetB.push(estateB);
      annualHistoryB.push({ giftTotal: actualTotal, taxYear, estateEnd: estateB });
    }else{
      estateB = estateB * (1 + r);
      dataAssetB.push(estateB);
      annualHistoryB.push({ giftTotal: 0, taxYear: 0, estateEnd: estateB });
    }

    // 年2〜N：毎年贈与
    for(let t=2; t<=years; t++){
      let plannedTotal = annualGiftB * recipients;
      let actualTotal = plannedTotal;

      if(estateB <= 0 || plannedTotal <= 0){
        actualTotal = 0;
      }else if(plannedTotal > estateB){
        actualTotal = estateB;
      }

      let perGift = (recipients > 0) ? actualTotal / recipients : 0;
      let taxYear = 0;

      if(perGift > 0){
        const baseAfterKiso = Math.max(0, perGift - BASE_DEDUCTION);
        const specialUse = Math.min(baseAfterKiso, remainingSpecialPerPerson);
        remainingSpecialPerPerson -= specialUse;
        
        const taxable = Math.max(0, baseAfterKiso - specialUse);
        const taxBase = truncateToThousand(taxable);
        const rawTax = taxBase * 0.20;
        const taxPerPerson = roundTax100(rawTax);
        
        taxYear = taxPerPerson * recipients;
        totalGiftTaxB += taxYear;

        const addbackPer = Math.max(0, perGift - BASE_DEDUCTION);
        addbackB += addbackPer * recipients;
        
        estateB = Math.max(0, estateB - actualTotal);
      }
      totalGiftAmountB += actualTotal;

      estateB = estateB * (1 + r);
      dataAssetB.push(estateB);
      annualHistoryB.push({ giftTotal: actualTotal, taxYear, estateEnd: estateB });
    }

    const estateBaseB = estateB + addbackB;
    // 相続税計算 (B)
    const taxDataB = calcInheritanceTaxData(estateBaseB, heirs);
    let estateTaxTotalB = taxDataB.totalTax;
    let spouseCreditB = 0;

    // 配偶者軽減 (B)
    if(hasSpouse && estateTaxTotalB > 0) {
      spouseCreditB = Math.floor(estateTaxTotalB * 0.5);
      estateTaxTotalB -= spouseCreditB;
    }

    // 精算課税分の贈与税控除
    let netEstateTaxB;
    let totalTaxB;
    // ※精算課税の場合、還付もあり得るのでマイナスを許容する計算ロジック
    if(estateTaxTotalB >= totalGiftTaxB){
      netEstateTaxB = estateTaxTotalB - totalGiftTaxB;
      totalTaxB = estateTaxTotalB; 
    }else{
      // 贈与税の方が多い場合（還付される）
      netEstateTaxB = estateTaxTotalB - totalGiftTaxB; // マイナス
      totalTaxB = estateTaxTotalB;
    }

    const finalNetB = Math.max(0, estateB - netEstateTaxB);
    
    // 実効税率(B)参考
    const effectiveRateB = (estateBaseB > 0) ? (estateTaxTotalB / estateBaseB) * 100 : 0;

    // 詳細テーブル構築
    let rowsHtml = '';
    for(let i=0; i<years; i++){
      const a = annualHistoryA[i];
      const b = annualHistoryB[i];
      rowsHtml += `
        <tr>
          <td style="text-align:center; background:#fafafa;">${i+1}年目</td>
          <td>${formatYen(Math.round(a.giftTotal))}</td>
          <td>${formatYen(Math.round(a.taxYear))}</td>
          <td>${formatYen(Math.round(a.estateEnd))}</td>
          <td>${formatYen(Math.round(b.giftTotal))}</td>
          <td>${formatYen(Math.round(b.taxYear))}</td>
          <td>${formatYen(Math.round(b.estateEnd))}</td>
        </tr>
      `;
    }
    
    // 最終結果行（相続発生後）
    rowsHtml += `
      <tr style="font-weight:bold; border-top:2px solid var(--border);">
        <td style="text-align:center; background:#fafafa; vertical-align:top; padding-top:12px;">相続発生時</td>
        <td colspan="3" style="background:#f0f8fa; text-align:right; line-height:1.8; padding:10px;">
          <div style="color:var(--muted); font-size:12px;">残財産: ${formatYen(Math.round(estateA))}</div>
          <div style="color:#b42318; font-size:12px;">+ 持戻し: ${formatYen(Math.round(addbackA))}</div>
          <div style="border-bottom:1px solid #ccc; margin:2px 0;"></div>
          <div style="font-weight:700;">= 課税価格: ${formatYen(Math.round(estateBaseA))}</div>
          <div style="margin-top:6px; color:var(--ink);">相続税額: ${formatYen(Math.round(netEstateTaxA))}</div>
          <div style="font-size:11px; color:var(--muted);">（実効税率: ${effectiveRateA.toFixed(1)}%）</div>
          <div style="color:var(--accent); font-weight:900; font-size:14px; margin-top:4px;">最終手取: ${formatYen(Math.round(finalNetA))}</div>
        </td>
        <td colspan="3" style="background:#fff3f3; text-align:right; line-height:1.8; padding:10px;">
          <div style="color:var(--muted); font-size:12px;">残財産: ${formatYen(Math.round(estateB))}</div>
          <div style="color:#b42318; font-size:12px;">+ 持戻し: ${formatYen(Math.round(addbackB))}</div>
          <div style="border-bottom:1px solid #ccc; margin:2px 0;"></div>
          <div style="font-weight:700;">= 課税価格: ${formatYen(Math.round(estateBaseB))}</div>
          <div style="margin-top:6px; color:var(--ink);">相続税額: ${formatYen(Math.round(netEstateTaxB))}</div>
          <div style="font-size:11px; color:var(--muted);">（実効税率: ${effectiveRateB.toFixed(1)}%）</div>
          <div style="color:var(--accent); font-weight:900; font-size:14px; margin-top:4px;">最終手取: ${formatYen(Math.round(finalNetB))}</div>
        </td>
      </tr>
    `;
    detailsTableBody.innerHTML = rowsHtml;

    // 計算詳細の内訳生成
    const calcDetailA = renderCalcDetail(
      '【暦年贈与シナリオ】相続税計算の内訳', 
      estateA, 
      addbackA, 
      `相続前${yearsForAddback}年間の贈与合計・基礎控除110万円控除前`,
      taxDataA.deduction, 
      taxDataA.taxable, 
      taxDataA.totalTax, 
      spouseCreditA, 
      netEstateTaxA, // 最終的な相続税額
      '贈与税額控除', // 追加クレジット名
      giftTaxCreditA // 控除額
    );

    const calcDetailB = renderCalcDetail(
      '【相続時精算課税シナリオ】相続税計算の内訳', 
      estateB, 
      addbackB, 
      '精算課税適用財産の累計額・基礎控除110万円控除後',
      taxDataB.deduction, 
      taxDataB.taxable, 
      taxDataB.totalTax, 
      spouseCreditB, 
      netEstateTaxB, // 最終的な相続税額
      '精算課税分の贈与税控除',
      totalGiftTaxB
    );

    calcDetailsContainer.innerHTML = calcDetailA + calcDetailB;

    // 結果表示
    multiAnnualTotalTax.textContent = formatYen(Math.round(totalTaxA)) + ' 円';
    multiAnnualFinalEstate.textContent = formatYen(Math.round(estateA)) + ' 円';
    multiSeisanTotalTax.textContent = formatYen(Math.round(totalTaxB)) + ' 円';
    multiSeisanFinalEstate.textContent = formatYen(Math.round(estateB)) + ' 円';

    // 補足説明の更新
    multiAnnualTaxDetail.textContent = `贈与税＋相続税額（相続前${yearsForAddback}年間の贈与額 ${formatYen(Math.round(addbackA))}円 を加算して計算）`;
    multiSeisanTaxDetail.textContent = `贈与税＋相続税額（精算課税適用財産 ${formatYen(Math.round(addbackB))}円 を加算して計算）`;

    const diff = totalTaxA - totalTaxB;
    multiTaxDiff.textContent = formatYen(Math.round(diff)) + ' 円';
    
    if(diff > 0){
      multiTaxDiffSub.textContent = 'プラス（暦年 ＞ 精算）となっているため、この前提では相続時精算課税シナリオの方が税負担が軽い結果です。';
      multiTaxAdvantage.textContent = '相続時精算課税 有利';
      multiTaxAdvantage.style.color = 'var(--danger)'; 
    }else if(diff < 0){
      multiTaxDiffSub.textContent = 'マイナス（暦年 ＜ 精算）となっているため、この前提では暦年贈与シナリオの方が税負担が軽い結果です。';
      multiTaxAdvantage.textContent = '暦年贈与 有利';
      multiTaxAdvantage.style.color = 'var(--accent)';
    }else{
      multiTaxDiffSub.textContent = '両シナリオの概算税負担は同程度となっています。その他の事情（将来の値上がり・ライフプラン等）も踏まえて検討が必要です。';
      multiTaxAdvantage.textContent = '差なし';
      multiTaxAdvantage.style.color = 'var(--muted)';
    }

    // トータル手取り差額の計算
    // トータル手取り = (贈与額累計 - 贈与税累計) + 相続後の残財産
    // ※贈与税は受贈者が負担するので手取りから引く
    // 修正後: 暦年贈与の手取り計算も、控除後の相続税(netEstateTaxA)を使用しているので整合性が取れています。
    const totalNetA = (totalGiftAmountA - totalGiftTaxA) + finalNetA;
    const totalNetB = (totalGiftAmountB - totalGiftTaxB) + finalNetB;
    const netDiff = totalNetB - totalNetA;

    multiNetDiff.textContent = formatYen(Math.round(netDiff)) + ' 円';
    
    if(netDiff > 0){
      multiNetAdvantage.textContent = '相続時精算課税 有利';
      multiNetAdvantage.style.color = 'var(--danger)'; 
    }else if(netDiff < 0){
      multiNetAdvantage.textContent = '暦年贈与 有利';
      multiNetAdvantage.style.color = 'var(--accent)';
    }else{
      multiNetAdvantage.textContent = '差なし';
      multiNetAdvantage.style.color = 'var(--muted)';
    }

    multiResultSummary.textContent = '入力いただいた前提条件のもとで、暦年贈与シナリオと相続時精算課税シナリオの税負担と相続時点の残財産を概算比較した結果です。';
    multiResultCard.classList.remove('hidden');

    // ===== グラフ描画 =====
    // 1. 税負担内訳（積上げ棒グラフ）
    if(taxBreakdownChart){ taxBreakdownChart.destroy(); }
    const ctx1 = document.getElementById('taxBreakdownChart').getContext('2d');
    taxBreakdownChart = new Chart(ctx1, {
      type: 'bar',
      data: {
        labels: ['暦年贈与シナリオ', '相続時精算課税シナリオ'],
        datasets: [
          {
            label: '贈与税総額',
            data: [Math.round(totalGiftTaxA), Math.round(totalGiftTaxB)],
            // 【修正】指定色: 濃いアクセント #568899
            backgroundColor: '#568899', 
            borderColor: '#456d7a',
            borderWidth: 1
          },
          {
            label: '相続税額',
            data: [Math.round(netEstateTaxA), Math.round(netEstateTaxB)],
            // 【修正】指定色: 薄い青緑 #A3CECD
            backgroundColor: '#A3CECD', 
            borderColor: '#8fb8b7',
            borderWidth: 1
          }
        ]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        scales: {
          x: { stacked: true },
          y: { 
            stacked: true,
            ticks: {
              callback: function(value) { return (value/10000) + '万円'; }
            }
          }
        },
        plugins: {
          tooltip: {
            callbacks: {
              label: function(context) {
                let label = context.dataset.label || '';
                if (label) { label += ': '; }
                if (context.parsed.y !== null) {
                  label += context.parsed.y.toLocaleString() + '円';
                }
                return label;
              }
            }
          }
        }
      }
    });

    // 2. 資産推移（折れ線グラフ + 最終手取り棒）
    const labels2 = [...chartLabels, '相続税納税後'];
    const dataA2 = [...dataAssetA, finalNetA];
    const dataB2 = [...dataAssetB, finalNetB];

    if(assetTransitionChart){ assetTransitionChart.destroy(); }
    const ctx2 = document.getElementById('assetTransitionChart').getContext('2d');
    assetTransitionChart = new Chart(ctx2, {
      type: 'line',
      data: {
        labels: labels2,
        datasets: [
          {
            label: '暦年贈与：資産残高',
            data: dataA2,
            // 【修正】テーブルの青系に合わせる: #578899
            borderColor: '#578899',
            backgroundColor: 'rgba(87, 136, 153, 0.2)',
            tension: 0.1,
            borderWidth: 2,
            pointRadius: 3
          },
          {
            label: '精算課税：資産残高',
            data: dataB2,
            // 【修正】テーブルの赤系に合わせる: #c86445 (テラコッタ)
            borderColor: '#c86445',
            backgroundColor: 'rgba(200, 100, 70, 0.2)',
            tension: 0.1,
            borderWidth: 2,
            pointRadius: 3
          }
        ]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        interaction: {
          mode: 'index',
          intersect: false,
        },
        scales: {
          y: {
            beginAtZero: true,
            ticks: {
              callback: function(value) { return (value/10000) + '万円'; }
            }
          }
        },
        plugins: {
          tooltip: {
            callbacks: {
              label: function(context) {
                let label = context.dataset.label || '';
                if (label) { label += ': '; }
                if (context.parsed.y !== null) {
                  label += Math.round(context.parsed.y).toLocaleString() + '円';
                }
                return label;
              }
            }
          }
        }
      }
    });
  }

  // 詳細エリアの開閉
  if(toggleDetailsBtn && detailsArea){
    toggleDetailsBtn.addEventListener('click', function(){
      if(detailsArea.classList.contains('hidden')){
        detailsArea.classList.remove('hidden');
        toggleDetailsBtn.textContent = '詳細データを閉じる';
      }else{
        detailsArea.classList.add('hidden');
        toggleDetailsBtn.textContent = '詳細データを見る';
      }
    });
  }

  // 結果コピー
  function fallbackCopy(text){
    const ta = document.createElement('textarea');
    ta.value = text;
    ta.style.position = 'fixed';
    ta.style.left = '-9999px';
    document.body.appendChild(ta);
    ta.focus();
    ta.select();
    try{
      document.execCommand('copy');
      alert('試算結果をコピーしました。');
    }catch(e){
      alert('コピーに失敗しました。');
    }
    document.body.removeChild(ta);
  }

  function handleCopyResult(){
    const tabMode = document.querySelector('input[name="tabMode"]:checked')?.value || 'single';

    if(tabMode === 'single'){
      const mode = document.querySelector('input[name="mode"]:checked')?.value || 'annual';
      const lines = [];
      const summary = (resultSummary.textContent || '').trim();

      lines.push('【贈与税試算結果（単年）】');
      if(summary) lines.push(summary);
      lines.push('');
      lines.push('概算贈与税額：' + (resultTax.textContent || '').trim());
      lines.push('基礎控除後の課税価格：' + (resultBase.textContent || '').trim());

      if(mode === 'annual'){
        lines.push('適用税率・控除額：' + (resultRate.textContent || '').trim());
      }else{
        lines.push('当年特別控除利用額：' + (resultSeisanSpecial.textContent || '').trim());
        lines.push((resultSeisanSub.textContent || '').trim());
      }
      lines.push('');
      lines.push('※本ツールは税額の「概算」を把握するためのものであり、実際の贈与の実行・申告にあたっては専門家にご相談ください。');

      const text = lines.join('\n');
      if(navigator.clipboard && navigator.clipboard.writeText){
        navigator.clipboard.writeText(text)
          .then(() => { alert('試算結果をコピーしました。'); })
          .catch(() => { fallbackCopy(text); });
      }else{
        fallbackCopy(text);
      }
    }else{
      const lines = [];
      lines.push('【贈与税・相続税試算結果（長期シミュレーション）】');
      lines.push((multiResultSummary.textContent || '').trim());
      lines.push('');
      lines.push('［暦年贈与シナリオ］');
      lines.push('トータル税負担：' + (multiAnnualTotalTax.textContent || '').trim());
      lines.push('相続時点の残財産：' + (multiAnnualFinalEstate.textContent || '').trim());
      lines.push('');
      lines.push('［相続時精算課税シナリオ］');
      lines.push('トータル税負担：' + (multiSeisanTotalTax.textContent || '').trim());
      lines.push('相続時点の残財産：' + (multiSeisanFinalEstate.textContent || '').trim());
      lines.push('');
      lines.push('税負担の差額（暦年 − 精算）：' + (multiTaxDiff.textContent || '').trim());
      lines.push((multiTaxDiffSub.textContent || '').trim());
      lines.push('');
      lines.push('※長期シミュレーションは、相続税を「想定相続税実効税率」による概算で計算しており、実際の相続税額とは異なる場合があります。');

      const text = lines.join('\n');
      if(navigator.clipboard && navigator.clipboard.writeText){
        navigator.clipboard.writeText(text)
          .then(() => { alert('試算結果をコピーしました。'); })
          .catch(() => { fallbackCopy(text); });
      }else{
        fallbackCopy(text);
      }
    }
  }

  // 全体リセット
  function handleResetAll(){
    const tabSingle = document.querySelector('input[name="tabMode"][value="single"]');
    if(tabSingle){ tabSingle.checked = true; }
    updateTabMode();

    const modeAnnual = document.querySelector('input[name="mode"][value="annual"]');
    if(modeAnnual){ modeAnnual.checked = true; }
    const annualModeGeneral = document.querySelector('input[name="annualMode"][value="general"]');
    if(annualModeGeneral){ annualModeGeneral.checked = true; }

    updateMode();
    updateAnnualInputs();
    clearAnnual();
    clearSeisan();
    resetResult();
    clearMultiInputs();
    window.scrollTo({ top:0, behavior:'smooth' });
  }

  // 印刷
  function handlePrint(){ window.print(); }

  // イベント設定
  modeRadios.forEach(r => r.addEventListener('change', updateMode));
  annualModeRadios.forEach(r => r.addEventListener('change', updateAnnualInputs));
  if(calcAnnualBtn) calcAnnualBtn.addEventListener('click', handleCalcAnnual);
  if(calcSeisanBtn) calcSeisanBtn.addEventListener('click', handleCalcSeisan);
  if(annualClear) annualClear.addEventListener('click', clearAnnual);
  if(seisanClear) seisanClear.addEventListener('click', clearSeisan);

  if(runMultiSimBtn) runMultiSimBtn.addEventListener('click', handleMultiSim);
  if(multiClearBtn) multiClearBtn.addEventListener('click', clearMultiInputs);
  if(loadSampleBtn) loadSampleBtn.addEventListener('click', loadSampleData);

  if(copyResultBtn) copyResultBtn.addEventListener('click', handleCopyResult);
  if(resetAllBtn) resetAllBtn.addEventListener('click', handleResetAll);
  if(printBtn) printBtn.addEventListener('click', handlePrint);

  // 初期表示
  updateTabMode();
  updateMode();
  updateAnnualInputs();
  resetResult();
  resetMultiResult();
})();
</script>

</body>
</html>
